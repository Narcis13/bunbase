---
phase: 08-single-binary-packaging
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - package.json
autonomous: true

must_haves:
  truths:
    - "Running `bun run build` produces a single binary file named 'bunbase'"
    - "The compiled binary starts and serves the admin UI at /_/"
    - "The compiled binary accepts --port flag and listens on specified port"
    - "The compiled binary creates SQLite database file on first run"
    - "The binary runs with zero external dependencies (no node_modules needed)"
  artifacts:
    - path: "package.json"
      provides: "Build script configuration"
      contains: "bun build --compile --minify"
  key_links:
    - from: "package.json scripts.build"
      to: "src/cli.ts"
      via: "compile entry point"
      pattern: "bun build.*--compile.*src/cli.ts"
---

<objective>
Configure build script and verify compiled binary works correctly.

Purpose: Finalize the single-binary packaging by updating build configuration and verifying all requirements are met.

Output: Updated package.json with correct build script, verified working binary.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/08-single-binary-packaging/08-RESEARCH.md
@.planning/phases/08-single-binary-packaging/08-01-SUMMARY.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update package.json build script</name>
  <files>package.json</files>
  <action>
Update the build script in package.json to compile correctly:

Change from:
```json
"build": "bun build --compile src/index.ts --outfile bunbase"
```

To:
```json
"build": "bun build --compile --minify src/cli.ts --outfile bunbase"
```

Key changes:
- Entry point: `src/cli.ts` (not src/index.ts)
- Add `--minify` flag for production optimization
- Output: `bunbase` (keeps same name)

This ensures:
- CLI argument parsing is included
- Frontend assets are minified
- Single binary is produced
  </action>
  <verify>
Check package.json contains updated build script:
```bash
grep -A1 '"build"' package.json
```
  </verify>
  <done>
Build script points to src/cli.ts with --minify flag.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build and verify binary</name>
  <files>bunbase (output)</files>
  <action>
Build the binary and run comprehensive verification:

1. **Build:**
```bash
bun run build
```

2. **Verify binary exists:**
```bash
ls -lh bunbase
```
Expected: Single file, ~50-70MB (includes Bun runtime)

3. **Verify --help flag:**
```bash
./bunbase --help
```
Expected: Usage information printed

4. **Start on custom port and verify:**
```bash
# Start binary on test port with test database
./bunbase --port 9999 --db test-binary.db &
BUNBASE_PID=$!

# Wait for startup
sleep 2

# Test admin UI is served
curl -s http://localhost:9999/_/ | head -5

# Test API responds
curl -s http://localhost:9999/api/collections/nonexistent/records

# Cleanup
kill $BUNBASE_PID
rm -f test-binary.db
```

5. **Verify database creation:**
The test above should have created `test-binary.db` file (then cleaned up).

6. **Verify no external dependencies:**
```bash
# Binary should run without node_modules
mkdir /tmp/bunbase-test
cp bunbase /tmp/bunbase-test/
cd /tmp/bunbase-test && ./bunbase --help
```
  </action>
  <verify>
All verification steps pass:
- Binary builds without errors
- Binary shows help when run with --help
- Binary serves admin UI at /_/
- Binary creates database on first run
- Binary runs without node_modules
  </verify>
  <done>
Compiled binary meets all DEPL requirements: single file, embedded UI, configurable port, auto-creates database, zero runtime deps.
  </done>
</task>

</tasks>

<verification>
1. `bun run build` completes without errors
2. `./bunbase --help` displays usage information
3. `./bunbase --port 9999 --db test.db` starts server on port 9999
4. `curl http://localhost:9999/_/` returns HTML admin UI
5. `test.db` file is created on first run
6. Binary runs from empty directory (no node_modules needed)
</verification>

<success_criteria>
- DEPL-01: Project compiles to single executable via `bun build --compile` (verified)
- DEPL-02: Compiled binary includes embedded React admin UI (verified via curl)
- DEPL-03: Binary runs with no external dependencies (verified in isolated directory)
- DEPL-04: Server starts on port 8090 by default, configurable via flag (verified)
- DEPL-05: SQLite database file created on first run (verified)
</success_criteria>

<output>
After completion, create `.planning/phases/08-single-binary-packaging/08-02-SUMMARY.md`
</output>

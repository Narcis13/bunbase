---
phase: 10-user-authentication
plan: 05
type: execute
wave: 2
depends_on: ["10-01", "10-02"]
files_modified:
  - src/auth/tokens.ts
  - src/auth/tokens.test.ts
  - src/api/server.ts
autonomous: true

must_haves:
  truths:
    - "User can request password reset via email"
    - "Password reset email is sent with secure token"
    - "User can set new password with valid reset token"
    - "All sessions invalidated after password reset"
  artifacts:
    - path: "src/auth/tokens.ts"
      provides: "Password reset token functions"
      exports: ["requestPasswordReset", "confirmPasswordReset"]
    - path: "src/api/server.ts"
      provides: "Password reset endpoints"
      contains: ["/auth/request-reset", "/auth/confirm-reset"]
  key_links:
    - from: "src/auth/tokens.ts"
      to: "src/auth/user.ts"
      via: "getUserByEmail import"
      pattern: "import.*getUserByEmail.*from.*user"
    - from: "src/auth/tokens.ts"
      to: "src/auth/user-jwt.ts"
      via: "revokeAllUserRefreshTokens"
      pattern: "revokeAllUserRefreshTokens"
---

<objective>
Implement password reset flow with secure one-time tokens.

Purpose: Allows users to recover access when they forget their password. Uses the same secure token infrastructure as email verification. All existing sessions are invalidated after password reset for security.

Output:
- Password reset request function (sends email without revealing user existence)
- Password reset confirmation function (validates token, updates password)
- API endpoints for password reset flow
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-user-authentication/10-RESEARCH.md
@.planning/phases/10-user-authentication/10-04-SUMMARY.md

# Token infrastructure from Plan 04
@src/auth/tokens.ts
@src/auth/user.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add password reset functions to tokens.ts</name>
  <files>
    src/auth/tokens.ts
    src/auth/tokens.test.ts
  </files>
  <action>
Update `src/auth/tokens.ts` to add password reset functions.

Add imports at top (getUserByEmail should already be imported from Plan 04, but verify and add if missing):
```typescript
import { getUserById, getUserByEmail } from "./user";  // getUserByEmail needed for password reset
import { validatePassword } from "./validation";
import { revokeAllUserRefreshTokens } from "./user-jwt";
```

Note: `getUserByEmail` is exported from `src/auth/user.ts`. Ensure this import is present at the top of the file.

Add these functions:

```typescript
/**
 * Request password reset for a user.
 * IMPORTANT: Always returns success to prevent email enumeration.
 * If email doesn't exist, silently does nothing.
 */
export async function requestPasswordReset(
  collectionName: string,
  email: string,
  baseUrl: string
): Promise<{ success: boolean }> {
  const collection = getCollection(collectionName);
  if (!collection || collection.type !== 'auth') {
    // Don't reveal collection type info
    return { success: true };
  }

  // getUserByEmail is imported from ./user
  const user = getUserByEmail(collectionName, email);

  // SECURITY: Don't reveal if user exists
  // Silently return success even if user doesn't exist
  if (!user) {
    return { success: true };
  }

  const { token } = await createVerificationToken(user.id, collectionName, 'password_reset');
  const resetLink = `${baseUrl}/api/collections/${collectionName}/auth/confirm-reset?token=${token}`;

  // Send email (if it fails, still return success to prevent enumeration)
  await sendEmail({
    to: user.email,
    subject: 'Reset your password',
    text: `You requested a password reset. Click the link below to set a new password:\n\n{{link}}\n\nThis link expires in 1 hour.\n\nIf you didn't request this, you can ignore this email.`,
    html: `<p>You requested a password reset. Click the link below to set a new password:</p><p><a href="{{link}}">Reset Password</a></p><p>This link expires in 1 hour.</p><p>If you didn't request this, you can ignore this email.</p>`,
    placeholders: { link: resetLink },
  });

  return { success: true };
}

/**
 * Confirm password reset with token and new password.
 */
export async function confirmPasswordReset(
  token: string,
  newPassword: string
): Promise<{ success: boolean; error?: string }> {
  const tokenInfo = await verifyToken(token, 'password_reset');
  if (!tokenInfo) {
    return { success: false, error: 'Invalid or expired token' };
  }

  // Get collection to check password requirements
  const collection = getCollection(tokenInfo.collectionName);
  if (!collection) {
    return { success: false, error: 'Invalid token' };
  }

  const options = collection.options ? JSON.parse(collection.options) : {};
  const minPasswordLength = options.minPasswordLength ?? 8;

  // Validate new password
  try {
    validatePassword(newPassword, minPasswordLength);
  } catch (err) {
    return { success: false, error: (err as Error).message };
  }

  // Hash new password
  const password_hash = await Bun.password.hash(newPassword, {
    algorithm: "argon2id",
    memoryCost: 65536,
    timeCost: 2,
  });

  // Update password
  const db = getDatabase();
  const now = new Date().toISOString();
  db.run(
    `UPDATE "${tokenInfo.collectionName}" SET password_hash = ?, updated_at = ? WHERE id = ?`,
    [password_hash, now, tokenInfo.userId]
  );

  // Mark token as used
  await markTokenUsed(token);

  // Revoke all refresh tokens (force re-login on all devices)
  revokeAllUserRefreshTokens(tokenInfo.userId);

  return { success: true };
}
```

Update `src/auth/tokens.test.ts` to add tests for:
- requestPasswordReset sends email for existing user
- requestPasswordReset returns success for non-existing user (no enumeration)
- confirmPasswordReset updates password with valid token
- confirmPasswordReset rejects invalid password
- confirmPasswordReset rejects expired token
- confirmPasswordReset rejects used token
- confirmPasswordReset revokes all refresh tokens
  </action>
  <verify>
Run `bun test src/auth/tokens.test.ts` - all tests pass
  </verify>
  <done>
Password reset functions added: requestPasswordReset (email enumeration safe), confirmPasswordReset (validates password, revokes sessions).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add password reset API endpoints</name>
  <files>
    src/api/server.ts
  </files>
  <action>
Update `src/api/server.ts` to add password reset endpoints.

Add import if not already present:
```typescript
import { requestPasswordReset, confirmPasswordReset } from "../auth/tokens";
```

Add these routes inside the routes object:

```typescript
"/api/collections/:name/auth/request-reset": {
  /**
   * POST /api/collections/:name/auth/request-reset
   * Request password reset (public endpoint)
   */
  POST: async (req) => {
    try {
      const { name } = req.params;

      if (!isAuthCollection(name)) {
        // Don't reveal collection type - just return success
        return Response.json({ message: "If an account exists, a reset email has been sent" });
      }

      const { email } = await req.json();
      if (!email) {
        return errorResponse("Email required", 400);
      }

      // Determine base URL from request
      const url = new URL(req.url);
      const baseUrl = `${url.protocol}//${url.host}`;

      await requestPasswordReset(name, email, baseUrl);

      // Always return same message (prevent enumeration)
      return Response.json({ message: "If an account exists, a reset email has been sent" });
    } catch (error) {
      // Don't reveal errors - always return success message
      return Response.json({ message: "If an account exists, a reset email has been sent" });
    }
  },
},

"/api/collections/:name/auth/confirm-reset": {
  /**
   * POST /api/collections/:name/auth/confirm-reset
   * Confirm password reset with token and new password
   */
  POST: async (req) => {
    try {
      const { name } = req.params;

      if (!isAuthCollection(name)) {
        return errorResponse(`"${name}" is not an auth collection`, 400);
      }

      const { token, newPassword } = await req.json();
      if (!token || !newPassword) {
        return errorResponse("Token and new password required", 400);
      }

      const result = await confirmPasswordReset(token, newPassword);
      if (!result.success) {
        return errorResponse(result.error!, 400);
      }

      return Response.json({ message: "Password reset successfully" });
    } catch (error) {
      const err = error as Error;
      return errorResponse(err.message, 400);
    }
  },

  /**
   * GET /api/collections/:name/auth/confirm-reset
   * Show password reset form (for link clicking)
   */
  GET: async (req) => {
    try {
      const { name } = req.params;
      const url = new URL(req.url);
      const token = url.searchParams.get('token');

      if (!token) {
        return new Response(
          `<html><body><h1>Error</h1><p>Token required</p></body></html>`,
          { status: 400, headers: { "Content-Type": "text/html" } }
        );
      }

      // Return a simple form for password reset
      // In production, this would typically redirect to a frontend app
      return new Response(
        `<!DOCTYPE html>
<html>
<head>
  <title>Reset Password</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 400px; margin: 50px auto; padding: 20px; }
    input { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; }
    button { width: 100%; padding: 10px; background: #0066cc; color: white; border: none; cursor: pointer; }
    button:hover { background: #0055aa; }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
  <h1>Reset Password</h1>
  <form id="resetForm">
    <input type="hidden" name="token" value="${token}">
    <label>New Password:</label>
    <input type="password" name="newPassword" required minlength="8" placeholder="Enter new password">
    <label>Confirm Password:</label>
    <input type="password" name="confirmPassword" required placeholder="Confirm new password">
    <button type="submit">Reset Password</button>
  </form>
  <p id="message"></p>
  <script>
    document.getElementById('resetForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const newPassword = form.newPassword.value;
      const confirmPassword = form.confirmPassword.value;

      if (newPassword !== confirmPassword) {
        document.getElementById('message').innerHTML = '<span class="error">Passwords do not match</span>';
        return;
      }

      try {
        const res = await fetch('', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: form.token.value, newPassword })
        });
        const data = await res.json();

        if (res.ok) {
          document.getElementById('message').innerHTML = '<span class="success">Password reset! You can now log in.</span>';
          form.style.display = 'none';
        } else {
          document.getElementById('message').innerHTML = '<span class="error">' + (data.error || 'Reset failed') + '</span>';
        }
      } catch (err) {
        document.getElementById('message').innerHTML = '<span class="error">Request failed</span>';
      }
    });
  </script>
</body>
</html>`,
        { headers: { "Content-Type": "text/html" } }
      );
    } catch (error) {
      const err = error as Error;
      return new Response(
        `<html><body><h1>Error</h1><p>${err.message}</p></body></html>`,
        { status: 400, headers: { "Content-Type": "text/html" } }
      );
    }
  },
},
```
  </action>
  <verify>
Run `bun test` to ensure all tests pass.
  </verify>
  <done>
Password reset endpoints added: POST request-reset (email enumeration safe), POST/GET confirm-reset (validates token, updates password).
  </done>
</task>

</tasks>

<verification>
1. `bun test src/auth/tokens.test.ts` - Token tests pass
2. `bun test` - All tests pass
3. Request-reset always returns same message (no enumeration)
4. Confirm-reset validates password and updates
5. All sessions invalidated after reset
</verification>

<success_criteria>
- AUTH-07 satisfied: User can request password reset
- AUTH-08 satisfied: User can confirm password reset with token
- Email enumeration prevented (same response for existing/non-existing emails)
- All refresh tokens revoked after password reset
- Simple HTML form provided for direct link clicking
</success_criteria>

<output>
After completion, create `.planning/phases/10-user-authentication/10-05-SUMMARY.md`
</output>

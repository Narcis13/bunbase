---
phase: 10-user-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/auth.ts
  - src/auth/validation.ts
  - src/auth/validation.test.ts
  - src/core/schema.ts
  - src/types/collection.ts
autonomous: true

must_haves:
  truths:
    - "Auth collection can be created with type: 'auth'"
    - "Auth collections have required system fields (email, password_hash, verified)"
    - "Password validation enforces minimum length and complexity rules"
  artifacts:
    - path: "src/types/auth.ts"
      provides: "User, AuthCollection, token payload types"
      exports: ["User", "UserWithHash", "AuthCollection", "AuthCollectionOptions", "UserTokenPayload", "RefreshTokenPayload"]
    - path: "src/auth/validation.ts"
      provides: "Password validation with configurable rules"
      exports: ["validatePassword", "PasswordValidationError"]
    - path: "src/types/collection.ts"
      provides: "Extended collection types with auth support"
      contains: "CollectionType"
  key_links:
    - from: "src/core/schema.ts"
      to: "src/types/collection.ts"
      via: "CollectionType import"
      pattern: "type.*CollectionType"
---

<objective>
Create the foundational types, password validation, and auth collection schema support for user authentication.

Purpose: Establishes the type system and collection infrastructure that all other auth features depend on. Auth collections are a special collection type with predefined system fields for user accounts.

Output:
- User and auth token type definitions
- Password validation function with configurable rules
- Extended schema support for auth collection type
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-user-authentication/10-RESEARCH.md

# Existing patterns to follow
@src/auth/admin.ts
@src/types/collection.ts
@src/core/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth types and password validation</name>
  <files>
    src/types/auth.ts
    src/auth/validation.ts
    src/auth/validation.test.ts
  </files>
  <action>
Create `src/types/auth.ts` with the following types:

```typescript
import type { JWTPayload } from "jose";

// User without password hash (safe to return to clients)
export interface User {
  id: string;
  email: string;
  verified: boolean;
  created_at: string;
  updated_at: string;
}

// User with password hash (internal use only)
export interface UserWithHash extends User {
  password_hash: string;
}

// Auth collection configuration options
export interface AuthCollectionOptions {
  // Minimum password length (default: 8)
  minPasswordLength?: number;
  // Require email verification before login (default: false)
  requireEmailVerification?: boolean;
}

// JWT payload for user access tokens (15 min)
export interface UserTokenPayload extends JWTPayload {
  userId: string;
  collectionId: string;
  collectionName: string;
  type: 'access';
}

// JWT payload for refresh tokens (7 days)
export interface RefreshTokenPayload extends JWTPayload {
  userId: string;
  collectionId: string;
  collectionName: string;
  tokenId: string;  // Unique ID for revocation lookup
  type: 'refresh';
}
```

Create `src/auth/validation.ts`:

```typescript
// Custom error for password validation failures
export class PasswordValidationError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'PasswordValidationError';
  }
}

// Validate password against rules
export function validatePassword(
  password: string,
  minLength: number = 8
): void {
  if (!password || typeof password !== 'string') {
    throw new PasswordValidationError('Password is required');
  }

  if (password.length < minLength) {
    throw new PasswordValidationError(
      `Password must be at least ${minLength} characters`
    );
  }

  // Basic complexity: at least one letter and one number
  if (!/[a-zA-Z]/.test(password)) {
    throw new PasswordValidationError(
      'Password must contain at least one letter'
    );
  }

  if (!/[0-9]/.test(password)) {
    throw new PasswordValidationError(
      'Password must contain at least one number'
    );
  }
}
```

Create `src/auth/validation.test.ts` with tests for:
- Valid passwords pass (8+ chars, has letter, has number)
- Passwords too short fail
- Passwords without letters fail
- Passwords without numbers fail
- Empty/null passwords fail
- Custom minLength works
  </action>
  <verify>
Run `bun test src/auth/validation.test.ts` - all tests pass
  </verify>
  <done>
Auth types exported from src/types/auth.ts. Password validation function validates length and complexity, throws PasswordValidationError on failure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend collection types for auth support</name>
  <files>
    src/types/collection.ts
  </files>
  <action>
Update `src/types/collection.ts` to add:

1. Add CollectionType enum/union:
```typescript
export type CollectionType = 'base' | 'auth';
```

2. Add CollectionRules interface for auth rules:
```typescript
// Access control rules for collection operations
// null = locked (admin only), '' = public, string = filter expression
export interface CollectionRules {
  listRule: string | null;
  viewRule: string | null;
  createRule: string | null;
  updateRule: string | null;
  deleteRule: string | null;
}
```

3. Extend Collection interface to include:
```typescript
export interface Collection {
  id: string;
  name: string;
  type: CollectionType;  // NEW
  options: string | null; // NEW - JSON for auth options
  rules: CollectionRules | null; // NEW
  created_at: string;
  updated_at: string;
}
```

4. Add AUTH_SYSTEM_FIELDS constant:
```typescript
// System fields automatically added to auth collections
export const AUTH_SYSTEM_FIELDS = [
  'email',
  'password_hash',
  'verified'
] as const;
```

Note: Do NOT modify FIELD_TYPE_MAP - it stays the same.
  </action>
  <verify>
Run `bun test` to ensure existing tests still pass (no breaking changes to existing code that uses Collection type)
  </verify>
  <done>
Collection type extended with type field ('base' | 'auth'), options field, rules field, and AUTH_SYSTEM_FIELDS constant.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update schema.ts for auth collections</name>
  <files>
    src/core/schema.ts
  </files>
  <action>
Update `src/core/schema.ts` to support auth collection creation:

1. Import new types:
```typescript
import type { CollectionType, CollectionRules, AUTH_SYSTEM_FIELDS } from "../types/collection.ts";
```

2. Update createCollection signature to accept optional type and options:
```typescript
export function createCollection(
  name: string,
  fields: FieldInput[],
  options?: {
    type?: CollectionType;
    authOptions?: AuthCollectionOptions;
    rules?: CollectionRules;
  }
): Collection
```

3. Inside createCollection:
   - Default type to 'base' if not provided
   - If type is 'auth':
     - Add system fields automatically (email as TEXT UNIQUE NOT NULL, password_hash as TEXT NOT NULL, verified as INTEGER DEFAULT 0)
     - Validate that user-defined fields don't conflict with system fields
     - Store authOptions as JSON in options column
   - Store rules as JSON if provided (default null for base collections)

4. Update the _collections INSERT to include type, options, rules columns

5. Update getCollection and getAllCollections to return the new fields

6. Add helper function:
```typescript
export function isAuthCollection(name: string): boolean {
  const collection = getCollection(name);
  return collection?.type === 'auth';
}
```

Important: The database table for auth collections should have columns:
- id TEXT PRIMARY KEY
- email TEXT UNIQUE NOT NULL
- password_hash TEXT NOT NULL
- verified INTEGER DEFAULT 0
- created_at TEXT
- updated_at TEXT
- (plus any user-defined fields)
  </action>
  <verify>
Run `bun test` to ensure all existing tests pass. Manually verify with:
```bash
bun -e "
import { initDatabase } from './src/core/database';
import { createCollection, getCollection } from './src/core/schema';
initDatabase(':memory:');
const c = createCollection('users', [], { type: 'auth' });
console.log('Created auth collection:', c);
console.log('Retrieved:', getCollection('users'));
"
```
  </verify>
  <done>
createCollection supports type: 'auth' which automatically adds email, password_hash, verified system fields. isAuthCollection helper returns true for auth collections.
  </done>
</task>

</tasks>

<verification>
1. `bun test` - All existing tests pass
2. `bun test src/auth/validation.test.ts` - Password validation tests pass
3. Auth collection can be created with system fields auto-added
4. Types compile without errors
</verification>

<success_criteria>
- AUTH-01 satisfied: Auth collection type exists with system fields
- AUTH-09 satisfied: Password validation enforces 8+ chars, letter, number
- No breaking changes to existing functionality
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-user-authentication/10-01-SUMMARY.md`
</output>

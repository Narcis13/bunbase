---
phase: 16-server-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli.ts
autonomous: true

must_haves:
  truths:
    - "CLI imports buildCustomRoutes and routeManifest from routes-generated.ts"
    - "CLI creates HookManager and RealtimeManager before building routes"
    - "CLI calls buildCustomRoutes with correct dependencies"
    - "CLI passes customRoutes to startServer"
    - "CLI logs custom routes in development mode"
  artifacts:
    - path: "src/cli.ts"
      provides: "CLI with route loading at startup"
      exports: []
  key_links:
    - from: "src/cli.ts"
      to: "src/routes-generated.ts"
      via: "import buildCustomRoutes, routeManifest"
      pattern: "import.*buildCustomRoutes.*routes-generated"
    - from: "src/cli.ts"
      to: "src/api/server.ts"
      via: "startServer call with customRoutes"
      pattern: "startServer.*customRoutes"
---

<objective>
Update the CLI entry point to load custom routes at startup and pass them to the server.

Purpose: Complete the integration chain so custom routes are discovered, built, and served when BunBase starts via CLI.

Output: Updated `src/cli.ts` that imports route manifest, builds custom routes with context dependencies, logs them in development mode, and passes them to the server.
</objective>

<execution_context>
@/Users/narcisbrindusescu/.claude/looppool/workflows/execute-plan.md
@/Users/narcisbrindusescu/.claude/looppool/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-server-integration/16-RESEARCH.md
@src/cli.ts
@src/routes-generated.ts
@src/api/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Import route building functions and add manager imports</name>
  <files>src/cli.ts</files>
  <action>
Add imports for route building and managers at the top of cli.ts:

```typescript
import { buildCustomRoutes, routeManifest } from './routes-generated';
import { HookManager, RealtimeManager } from './api/server';
```

The HookManager and RealtimeManager are already re-exported from api/server.ts, so we import them from there to maintain the existing dependency pattern.
  </action>
  <verify>TypeScript compiles: `bun build --no-bundle src/cli.ts`</verify>
  <done>CLI imports buildCustomRoutes, routeManifest, HookManager, and RealtimeManager</done>
</task>

<task type="auto">
  <name>Task 2: Build custom routes and update startServer call</name>
  <files>src/cli.ts</files>
  <action>
In the main() function, after loading SMTP config and before calling startServer():

1. Create manager instances:
```typescript
// Create managers for route building (these will be reused by startServer)
const hookManager = new HookManager();
const realtimeManager = new RealtimeManager();
```

2. Build custom routes with dependencies:
```typescript
// Build custom routes with context dependencies
const customRoutes = buildCustomRoutes({
  hooks: hookManager,
  realtime: realtimeManager,
});
```

3. Add development mode logging after building routes:
```typescript
// Log routes in development mode
const isDev = Bun.env.NODE_ENV === 'development' || Bun.env.BUNBASE_DEV === 'true';
if (isDev && routeManifest.routes.length > 0) {
  console.log(`Custom routes (${routeManifest.routes.length}):`);
  for (const route of routeManifest.routes) {
    console.log(`  ${route.methods.join(',')} ${route.path}`);
  }
}
```

4. Update the startServer() call to pass managers and custom routes:
```typescript
// Start server with custom routes
await startServer(port, dbPath, hookManager, smtpConfig, realtimeManager, customRoutes);
```

Note: We pass the hookManager and realtimeManager we created to startServer so that the same instances are used for both custom routes and system routes. startServer will not create new instances when these are provided.
  </action>
  <verify>TypeScript compiles: `bun build --no-bundle src/cli.ts`</verify>
  <done>CLI builds custom routes and passes them (with managers) to startServer</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `bun build --no-bundle src/cli.ts`
2. Build routes first: `bun run build:routes`
3. Server starts and shows custom routes: `BUNBASE_DEV=true bun src/cli.ts` (should log "Custom routes (N):" followed by route paths)
4. Health route responds: Start server, then `curl http://localhost:8090/api/health` should return `{"status":"ok"}`
5. Stats route responds: `curl http://localhost:8090/api/stats` should return collection statistics
</verification>

<success_criteria>
- CLI imports buildCustomRoutes and routeManifest from routes-generated.ts
- CLI creates HookManager and RealtimeManager instances
- CLI calls buildCustomRoutes with hooks and realtime dependencies
- CLI logs custom routes when BUNBASE_DEV=true or NODE_ENV=development
- CLI passes hookManager, realtimeManager, and customRoutes to startServer
- Custom routes (health, stats) respond correctly when server is running
- Server compiles and starts without errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-server-integration/16-02-SUMMARY.md`
</output>

---
phase: 16-server-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/server.ts
autonomous: true

must_haves:
  truths:
    - "createServer() accepts a customRoutes parameter"
    - "Custom routes are merged into Bun.serve() routes object"
    - "Custom routes appear between system routes and admin routes in merge order"
    - "startServer() accepts and passes customRoutes to createServer()"
    - "Development mode enables HMR and console logging when BUNBASE_DEV=true or NODE_ENV=development"
  artifacts:
    - path: "src/api/server.ts"
      provides: "Server integration with custom routes"
      exports: ["createServer", "startServer"]
  key_links:
    - from: "src/api/server.ts"
      to: "customRoutes parameter"
      via: "object spread in routes config"
      pattern: "\\.\\.\\.\\(customRoutes"
---

<objective>
Modify the BunBase server to accept and merge custom routes from the generated manifest.

Purpose: Enable custom route handlers to be served alongside system routes, completing the server-side integration for custom API endpoints.

Output: Updated `src/api/server.ts` with `customRoutes` parameter in both `createServer()` and `startServer()`, plus development mode configuration.
</objective>

<execution_context>
@/Users/narcisbrindusescu/.claude/looppool/workflows/execute-plan.md
@/Users/narcisbrindusescu/.claude/looppool/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-server-integration/16-RESEARCH.md
@src/api/server.ts
@src/routes-generated.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add customRoutes parameter to createServer</name>
  <files>src/api/server.ts</files>
  <action>
Modify `createServer()` function signature to accept a fourth parameter:

```typescript
export function createServer(
  port: number = 8090,
  hooks?: HookManager,
  realtime?: RealtimeManager,
  customRoutes?: Record<string, Record<string, (req: Request) => Promise<Response>>>
)
```

Add type alias near top of file for readability:
```typescript
type CustomRouteHandler = (req: Request) => Promise<Response>;
type CustomRoutes = Record<string, Record<string, CustomRouteHandler>>;
```

In the Bun.serve() routes object, spread customRoutes AFTER the system routes (CRUD, auth, realtime, files) but BEFORE the admin routes (/_/*). This ensures:
1. System routes have first priority
2. Custom routes can add new paths
3. Admin routes' catch-all wildcard doesn't intercept custom routes

Find the line with `"/_/api/auth/login"` and insert custom routes spread just before it:

```typescript
// Custom routes (from routes-generated.ts)
...(customRoutes ?? {}),

// Admin authentication routes (must be after custom routes due to /_/* wildcard)
"/_/api/auth/login": {
```
  </action>
  <verify>TypeScript compiles: `bun build --no-bundle src/api/server.ts`</verify>
  <done>createServer() accepts customRoutes parameter and spreads it into routes object in correct position</done>
</task>

<task type="auto">
  <name>Task 2: Add customRoutes parameter to startServer</name>
  <files>src/api/server.ts</files>
  <action>
Modify `startServer()` function signature to accept a sixth parameter:

```typescript
export async function startServer(
  port: number = 8090,
  dbPath: string = "bunbase.db",
  hooks?: HookManager,
  smtpConfig?: SmtpConfig | null,
  realtime?: RealtimeManager,
  customRoutes?: CustomRoutes
)
```

Update the createServer() call at the end of startServer() to pass customRoutes:

```typescript
const server = createServer(port, hookManager, realtimeManager, customRoutes);
```

Update the JSDoc comment for startServer() to document the new parameter:
```typescript
* @param customRoutes - Optional custom routes object from buildCustomRoutes()
```
  </action>
  <verify>TypeScript compiles: `bun build --no-bundle src/api/server.ts`</verify>
  <done>startServer() accepts customRoutes parameter and passes it to createServer()</done>
</task>

<task type="auto">
  <name>Task 3: Add development mode configuration</name>
  <files>src/api/server.ts</files>
  <action>
Add development mode detection and configuration to Bun.serve() in createServer().

Add at the beginning of createServer() function:
```typescript
// Detect development mode
const isDev = Bun.env.NODE_ENV === 'development' || Bun.env.BUNBASE_DEV === 'true';
```

Modify the Bun.serve() call to include development configuration:
```typescript
return Bun.serve({
  port,
  development: isDev ? {
    hmr: true,      // Enable hot module replacement
    console: true,  // Stream browser console to terminal
  } : false,
  routes: {
    // ... existing routes
  },
  fetch(req) {
    return errorResponse("Not found", 404);
  },
});
```

Note: This enables Bun's built-in HMR when running in development mode. The `--hot` flag must still be used when starting the server for HMR to work (e.g., `bun --hot src/cli.ts`).
  </action>
  <verify>TypeScript compiles: `bun build --no-bundle src/api/server.ts`</verify>
  <done>Bun.serve() includes development mode config that enables HMR and console when isDev is true</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `bun build --no-bundle src/api/server.ts`
2. Existing tests pass: `bun test src/api/server.test.ts`
3. Server starts successfully: `bun src/cli.ts --help` (basic sanity check)
</verification>

<success_criteria>
- createServer() has customRoutes parameter with correct TypeScript type
- customRoutes is spread into routes object between system routes and admin routes
- startServer() has customRoutes parameter and passes it through
- Development mode detection uses both NODE_ENV and BUNBASE_DEV
- Bun.serve() includes development configuration for HMR
- All existing server tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/16-server-integration/16-01-SUMMARY.md`
</output>

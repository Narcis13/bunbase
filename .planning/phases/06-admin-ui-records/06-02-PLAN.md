---
phase: 06-admin-ui-records
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/admin/App.tsx
  - src/admin/components/layout/Layout.tsx
  - src/admin/components/layout/AppSidebar.tsx
  - src/admin/hooks/useCollections.ts
  - src/admin/hooks/useAuth.ts
  - src/api/server.ts
autonomous: true

must_haves:
  truths:
    - "Admin sees collections listed in sidebar after login"
    - "Clicking collection in sidebar navigates to that collection view"
    - "Sidebar distinguishes system collections from user collections"
    - "Unauthenticated users are redirected to login"
  artifacts:
    - path: "src/admin/components/layout/Layout.tsx"
      provides: "Main layout with sidebar and content area"
      min_lines: 30
    - path: "src/admin/components/layout/AppSidebar.tsx"
      provides: "Sidebar with collections list"
      min_lines: 50
    - path: "src/admin/hooks/useCollections.ts"
      provides: "Hook to fetch collections from API"
      exports: ["useCollections"]
    - path: "src/admin/hooks/useAuth.ts"
      provides: "Hook for auth state management"
      exports: ["useAuth"]
  key_links:
    - from: "src/admin/App.tsx"
      to: "src/admin/components/layout/Layout.tsx"
      via: "component import"
      pattern: "import.*Layout"
    - from: "src/admin/components/layout/AppSidebar.tsx"
      to: "src/admin/hooks/useCollections.ts"
      via: "hook call"
      pattern: "useCollections"
---

<objective>
Create the admin layout with sidebar navigation and view state routing

Purpose: Establish the app shell that provides navigation between collections and views
Output: Working sidebar with collection list, main content area, and view state routing
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-admin-ui-records/06-CONTEXT.md
@.planning/phases/06-admin-ui-records/06-RESEARCH.md
@src/admin/App.tsx
@src/admin/lib/api.ts
@src/core/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create collections API endpoint and hooks</name>
  <files>
    - src/api/server.ts
    - src/admin/hooks/useCollections.ts
    - src/admin/hooks/useAuth.ts
  </files>
  <action>
**Update src/api/server.ts** - Add endpoint to list collections:

Add a new route `/_/api/collections` that returns all collections with field count:
```typescript
"/_/api/collections": {
  GET: async (req) => {
    const adminOrError = await requireAdmin(req);
    if (adminOrError instanceof Response) return adminOrError;

    const collections = getAllCollections();
    // Add field count and record count for each collection
    const result = collections.map(c => ({
      ...c,
      fieldCount: getFields(c.name).length,
      // Get record count (simple query)
    }));
    return Response.json(result);
  },
}
```

Import `getAllCollections` and `getFields` from `../core/schema.ts`.

Add a record count query helper that counts records in each collection table.

**Create src/admin/hooks/useAuth.ts** - Auth state hook:
```typescript
import { useState, useEffect, useCallback } from "react";

interface Admin {
  id: string;
  email: string;
}

export function useAuth() {
  const [admin, setAdmin] = useState<Admin | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const checkAuth = useCallback(async () => {
    const token = localStorage.getItem("bunbase_token");
    if (!token) {
      setLoading(false);
      return;
    }

    try {
      const response = await fetch("/_/api/auth/me", {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (response.ok) {
        const data = await response.json();
        setAdmin(data);
      } else {
        localStorage.removeItem("bunbase_token");
      }
    } catch (e) {
      console.error("Auth check failed:", e);
    } finally {
      setLoading(false);
    }
  }, []);

  const login = async (email: string, password: string) => {
    const response = await fetch("/_/api/auth/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password }),
    });
    if (!response.ok) {
      const data = await response.json();
      throw new Error(data.error || "Login failed");
    }
    const { token, admin } = await response.json();
    localStorage.setItem("bunbase_token", token);
    setAdmin(admin);
  };

  const logout = () => {
    localStorage.removeItem("bunbase_token");
    setAdmin(null);
  };

  useEffect(() => {
    checkAuth();
  }, [checkAuth]);

  return { admin, loading, error, login, logout, isAuthenticated: !!admin };
}
```

**Create src/admin/hooks/useCollections.ts** - Collections fetcher:
```typescript
import { useState, useEffect } from "react";
import { fetchWithAuth } from "@/lib/api";

interface Collection {
  id: string;
  name: string;
  fieldCount: number;
  recordCount: number;
  created_at: string;
  updated_at: string;
}

export function useCollections() {
  const [collections, setCollections] = useState<Collection[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const refetch = async () => {
    setLoading(true);
    try {
      const response = await fetchWithAuth("/_/api/collections");
      const data = await response.json();
      setCollections(data);
      setError(null);
    } catch (e) {
      setError((e as Error).message);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    refetch();
  }, []);

  return { collections, loading, error, refetch };
}
```
  </action>
  <verify>
    - `grep "/_/api/collections" src/api/server.ts` shows the route
    - `ls src/admin/hooks/` shows useAuth.ts and useCollections.ts
    - `bun run typecheck` passes
  </verify>
  <done>
    Collections API endpoint created, auth and collections hooks implemented
  </done>
</task>

<task type="auto">
  <name>Task 2: Create layout components with sidebar</name>
  <files>
    - src/admin/components/layout/Layout.tsx
    - src/admin/components/layout/AppSidebar.tsx
  </files>
  <action>
**Create src/admin/components/layout/AppSidebar.tsx** - Sidebar component:

Use shadcn/ui Sidebar component pattern with:
- BunBase logo/title at top
- "Dashboard" link
- "Collections" section header
- List of collections with icons (Database icon from lucide-react)
- Collections grouped: system collections (_collections, _fields, _admins) vs user collections
- Active state highlighting for current collection
- Skeleton loader while loading
- Click handler to navigate to collection

```typescript
import { Database, LayoutDashboard, ChevronRight } from "lucide-react";
import {
  Sidebar,
  SidebarContent,
  SidebarGroup,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarMenu,
  SidebarMenuButton,
  SidebarMenuItem,
} from "@/components/ui/sidebar";
import { useCollections } from "@/hooks/useCollections";
import { Skeleton } from "@/components/ui/skeleton";

interface AppSidebarProps {
  currentCollection?: string;
  onNavigate: (view: { type: string; collection?: string }) => void;
}

export function AppSidebar({ currentCollection, onNavigate }: AppSidebarProps) {
  const { collections, loading } = useCollections();

  // Separate system and user collections
  const systemCollections = collections.filter(c => c.name.startsWith("_"));
  const userCollections = collections.filter(c => !c.name.startsWith("_"));

  return (
    <Sidebar>
      <SidebarHeader className="border-b px-4 py-3">
        <span className="text-lg font-semibold">BunBase</span>
      </SidebarHeader>
      <SidebarContent>
        {/* Dashboard link */}
        <SidebarGroup>
          <SidebarMenu>
            <SidebarMenuItem>
              <SidebarMenuButton
                onClick={() => onNavigate({ type: "dashboard" })}
                isActive={!currentCollection}
              >
                <LayoutDashboard className="h-4 w-4" />
                <span>Dashboard</span>
              </SidebarMenuButton>
            </SidebarMenuItem>
          </SidebarMenu>
        </SidebarGroup>

        {/* User Collections */}
        <SidebarGroup>
          <SidebarGroupLabel>Collections</SidebarGroupLabel>
          <SidebarGroupContent>
            {loading ? (
              <div className="space-y-2 px-2">
                <Skeleton className="h-8 w-full" />
                <Skeleton className="h-8 w-full" />
              </div>
            ) : userCollections.length === 0 ? (
              <p className="px-4 py-2 text-sm text-muted-foreground">
                No collections yet
              </p>
            ) : (
              <SidebarMenu>
                {userCollections.map((collection) => (
                  <SidebarMenuItem key={collection.id}>
                    <SidebarMenuButton
                      onClick={() => onNavigate({ type: "collection", collection: collection.name })}
                      isActive={currentCollection === collection.name}
                    >
                      <Database className="h-4 w-4" />
                      <span>{collection.name}</span>
                      <span className="ml-auto text-xs text-muted-foreground">
                        {collection.recordCount}
                      </span>
                    </SidebarMenuButton>
                  </SidebarMenuItem>
                ))}
              </SidebarMenu>
            )}
          </SidebarGroupContent>
        </SidebarGroup>

        {/* System Collections (collapsed by default) */}
        {systemCollections.length > 0 && (
          <SidebarGroup>
            <SidebarGroupLabel>System</SidebarGroupLabel>
            <SidebarGroupContent>
              <SidebarMenu>
                {systemCollections.map((collection) => (
                  <SidebarMenuItem key={collection.id}>
                    <SidebarMenuButton
                      onClick={() => onNavigate({ type: "collection", collection: collection.name })}
                      isActive={currentCollection === collection.name}
                    >
                      <Database className="h-4 w-4" />
                      <span>{collection.name}</span>
                    </SidebarMenuButton>
                  </SidebarMenuItem>
                ))}
              </SidebarMenu>
            </SidebarGroupContent>
          </SidebarGroup>
        )}
      </SidebarContent>
    </Sidebar>
  );
}
```

**Create src/admin/components/layout/Layout.tsx** - Main layout:

```typescript
import { SidebarProvider, SidebarInset, SidebarTrigger } from "@/components/ui/sidebar";
import { AppSidebar } from "./AppSidebar";

interface LayoutProps {
  children: React.ReactNode;
  currentCollection?: string;
  onNavigate: (view: { type: string; collection?: string }) => void;
}

export function Layout({ children, currentCollection, onNavigate }: LayoutProps) {
  return (
    <SidebarProvider>
      <AppSidebar currentCollection={currentCollection} onNavigate={onNavigate} />
      <SidebarInset>
        <header className="flex h-14 items-center gap-4 border-b px-4">
          <SidebarTrigger />
          <h1 className="text-lg font-semibold">
            {currentCollection || "Dashboard"}
          </h1>
        </header>
        <main className="flex-1 p-4">
          {children}
        </main>
      </SidebarInset>
    </SidebarProvider>
  );
}
```
  </action>
  <verify>
    - `ls src/admin/components/layout/` shows Layout.tsx, AppSidebar.tsx
    - `grep "SidebarProvider" src/admin/components/layout/Layout.tsx` confirms sidebar usage
    - `bun run typecheck` passes
  </verify>
  <done>
    Layout and sidebar components created with collections list and navigation
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement view state routing in App.tsx</name>
  <files>
    - src/admin/App.tsx
    - src/admin/components/views/DashboardPlaceholder.tsx
    - src/admin/components/views/CollectionPlaceholder.tsx
    - src/admin/components/views/LoginPage.tsx
  </files>
  <action>
**Update src/admin/App.tsx** - View state routing:

Implement simple state-based routing as described in RESEARCH.md:

```typescript
import { useState } from "react";
import { Layout } from "@/components/layout/Layout";
import { useAuth } from "@/hooks/useAuth";
import { LoginPage } from "@/components/views/LoginPage";
import { DashboardPlaceholder } from "@/components/views/DashboardPlaceholder";
import { CollectionPlaceholder } from "@/components/views/CollectionPlaceholder";
import { Skeleton } from "@/components/ui/skeleton";

type View =
  | { type: "dashboard" }
  | { type: "collection"; collection: string };

export default function App() {
  const { admin, loading, login, logout, isAuthenticated } = useAuth();
  const [view, setView] = useState<View>({ type: "dashboard" });

  // Show loading state while checking auth
  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Skeleton className="h-8 w-32" />
      </div>
    );
  }

  // Show login page if not authenticated
  if (!isAuthenticated) {
    return <LoginPage onLogin={login} />;
  }

  const handleNavigate = (newView: { type: string; collection?: string }) => {
    if (newView.type === "dashboard") {
      setView({ type: "dashboard" });
    } else if (newView.type === "collection" && newView.collection) {
      setView({ type: "collection", collection: newView.collection });
    }
  };

  return (
    <Layout
      currentCollection={view.type === "collection" ? view.collection : undefined}
      onNavigate={handleNavigate}
    >
      {view.type === "dashboard" && <DashboardPlaceholder />}
      {view.type === "collection" && (
        <CollectionPlaceholder collection={view.collection} />
      )}
    </Layout>
  );
}
```

**Create src/admin/components/views/LoginPage.tsx**:

```typescript
import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";

interface LoginPageProps {
  onLogin: (email: string, password: string) => Promise<void>;
}

export function LoginPage({ onLogin }: LoginPageProps) {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    setLoading(true);
    try {
      await onLogin(email, password);
    } catch (e) {
      setError((e as Error).message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="flex items-center justify-center min-h-screen bg-background">
      <Card className="w-[400px]">
        <CardHeader>
          <CardTitle>BunBase Admin</CardTitle>
          <CardDescription>Sign in to manage your data</CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="email">Email</Label>
              <Input
                id="email"
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="admin@bunbase.local"
                required
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="password">Password</Label>
              <Input
                id="password"
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
              />
            </div>
            {error && (
              <p className="text-sm text-destructive">{error}</p>
            )}
            <Button type="submit" className="w-full" disabled={loading}>
              {loading ? "Signing in..." : "Sign in"}
            </Button>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
```

**Create src/admin/components/views/DashboardPlaceholder.tsx**:

```typescript
export function DashboardPlaceholder() {
  return (
    <div className="text-center py-12">
      <h2 className="text-2xl font-semibold">Welcome to BunBase</h2>
      <p className="mt-2 text-muted-foreground">
        Select a collection from the sidebar to view records
      </p>
    </div>
  );
}
```

**Create src/admin/components/views/CollectionPlaceholder.tsx**:

```typescript
interface CollectionPlaceholderProps {
  collection: string;
}

export function CollectionPlaceholder({ collection }: CollectionPlaceholderProps) {
  return (
    <div className="text-center py-12">
      <h2 className="text-2xl font-semibold">{collection}</h2>
      <p className="mt-2 text-muted-foreground">
        Records table coming in next plan
      </p>
    </div>
  );
}
```
  </action>
  <verify>
    - `ls src/admin/components/views/` shows LoginPage.tsx, DashboardPlaceholder.tsx, CollectionPlaceholder.tsx
    - `bun run typecheck` passes
    - Start server: `JWT_SECRET=test bun run src/api/server.ts`
    - Browser at /_/ shows login page
    - After login, sidebar shows collections (if any exist)
    - Clicking collection changes main content area
  </verify>
  <done>
    View state routing implemented with login, dashboard, and collection views
  </done>
</task>

</tasks>

<verification>
1. `bun run typecheck` - No TypeScript errors
2. Start server: `JWT_SECRET=test bun run src/api/server.ts`
3. Browser tests at http://localhost:8090/_/:
   - Unauthenticated: Shows login page
   - Login with admin credentials: Redirects to dashboard
   - Sidebar shows "Dashboard" and collections list
   - Click collection: Main area shows collection name
   - Sidebar highlights active collection
4. API test: `curl -H "Authorization: Bearer <token>" http://localhost:8090/_/api/collections` returns collections array
</verification>

<success_criteria>
- Login page renders with email/password form
- Successful login stores token and shows dashboard
- Sidebar lists all collections (UI-01)
- Collections grouped by system vs user
- Clicking collection navigates view
- Layout shows current collection name in header
- Unauthenticated access redirects to login
</success_criteria>

<output>
After completion, create `.planning/phases/06-admin-ui-records/06-02-SUMMARY.md`
</output>

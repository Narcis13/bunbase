---
phase: 12-realtime-sse
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/realtime/sse.ts
  - src/realtime/sse.test.ts
  - src/realtime/manager.ts
  - src/realtime/manager.test.ts
autonomous: true

must_haves:
  truths:
    - "SSE messages are formatted according to spec (event, data, id fields)"
    - "SSE comments for keep-alive are formatted correctly"
    - "RealtimeManager can register and remove clients"
    - "RealtimeManager tracks client controllers and subscriptions"
  artifacts:
    - path: "src/realtime/sse.ts"
      provides: "SSE message formatting utilities"
      exports: ["formatSSEMessage", "formatSSEComment", "SSEMessage"]
    - path: "src/realtime/manager.ts"
      provides: "RealtimeManager class for connection tracking"
      exports: ["RealtimeManager", "RealtimeClient", "Subscription"]
  key_links:
    - from: "src/realtime/sse.ts"
      to: "SSE spec"
      via: "message formatting"
      pattern: "event:.*data:.*\\n\\n"
---

<objective>
Create SSE message formatting utilities and RealtimeManager class for tracking connections.

Purpose: Establish the foundation for SSE realtime functionality with proper message formatting and client connection management.
Output: src/realtime/sse.ts (message formatting) and src/realtime/manager.ts (connection tracking)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-realtime-sse/12-RESEARCH.md

# Existing patterns
@src/core/hooks.ts
@src/auth/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SSE message formatting utilities</name>
  <files>src/realtime/sse.ts, src/realtime/sse.test.ts</files>
  <action>
Create SSE message formatting utilities following the SSE specification:

1. Create `src/realtime/sse.ts` with:
   - `SSEMessage` interface with optional `event`, required `data`, optional `id`, optional `retry` fields
   - `formatSSEMessage(message: SSEMessage): string` - formats message per SSE spec:
     - If event provided: `event: {event}\n`
     - If id provided: `id: {id}\n`
     - If retry provided: `retry: {retry}\n`
     - Data: `data: {JSON.stringify(data)}\n`
     - End with `\n` (total of two newlines at end)
   - `formatSSEComment(comment: string): string` - returns `: {comment}\n\n`
   - Export all functions and types

2. Create `src/realtime/sse.test.ts` with tests for:
   - Basic message with only data
   - Message with event name
   - Message with id
   - Message with retry
   - Message with all fields
   - Comment formatting
   - Multi-line data (JSON with newlines)
   - Empty data object

Use nanoid (already in project) for generating event IDs in examples.
  </action>
  <verify>Run `bun test src/realtime/sse.test.ts` - all tests pass</verify>
  <done>SSE message formatting returns spec-compliant strings with proper newline handling</done>
</task>

<task type="auto">
  <name>Task 2: Create RealtimeManager class for connection tracking</name>
  <files>src/realtime/manager.ts, src/realtime/manager.test.ts</files>
  <action>
Create RealtimeManager class for tracking SSE connections and subscriptions:

1. Create `src/realtime/manager.ts` with:
   - `Subscription` interface: `{ collection: string; recordId: string | "*" }`
   - `RealtimeClient` interface:
     - `id: string` - client ID (nanoid)
     - `controller: ReadableStreamDirectController` - for sending messages
     - `subscriptions: Subscription[]` - active subscriptions
     - `user: AuthenticatedUser | null` - user context (import from middleware)
     - `lastActivity: number` - timestamp for inactivity tracking
   - `RealtimeManager` class with:
     - Private `clients: Map<string, RealtimeClient>`
     - `registerClient(clientId: string, controller: ReadableStreamDirectController): RealtimeClient`
     - `removeClient(clientId: string): void`
     - `getClient(clientId: string): RealtimeClient | undefined`
     - `setClientAuth(clientId: string, user: AuthenticatedUser | null): void`
     - `setSubscriptions(clientId: string, subscriptions: Subscription[]): void`
     - `updateActivity(clientId: string): void` - updates lastActivity timestamp
     - `getClientCount(): number` - for monitoring
   - Export types and class

2. Create `src/realtime/manager.test.ts` with tests for:
   - Register a new client
   - Remove a client
   - Get client by ID (exists and not exists)
   - Set client auth context
   - Set subscriptions
   - Update activity timestamp
   - Get client count
   - Multiple clients

Use mock controller object for tests (just needs to be truthy, not real controller).
Import AuthenticatedUser type from src/auth/middleware.ts.
  </action>
  <verify>Run `bun test src/realtime/manager.test.ts` - all tests pass</verify>
  <done>RealtimeManager tracks clients with IDs, controllers, subscriptions, and activity timestamps</done>
</task>

</tasks>

<verification>
- `bun test src/realtime/` passes all tests
- SSE messages end with `\n\n` (two newlines)
- RealtimeManager stores and retrieves clients correctly
</verification>

<success_criteria>
1. SSE message formatting produces spec-compliant output
2. RealtimeManager can register, track, and remove clients
3. All tests pass
4. Types are properly exported for use by other modules
</success_criteria>

<output>
After completion, create `.planning/phases/12-realtime-sse/12-01-SUMMARY.md`
</output>

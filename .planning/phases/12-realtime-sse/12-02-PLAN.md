---
phase: 12-realtime-sse
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/realtime/topics.ts
  - src/realtime/topics.test.ts
autonomous: true

must_haves:
  truths:
    - "Topic strings parse to collection and recordId components"
    - "Invalid topic formats return null"
    - "Subscription matching correctly handles wildcards"
    - "Record events match both specific and wildcard subscriptions"
  artifacts:
    - path: "src/realtime/topics.ts"
      provides: "Topic parsing and subscription matching"
      exports: ["parseTopic", "matchesSubscription", "formatTopic"]
  key_links:
    - from: "src/realtime/topics.ts"
      to: "PocketBase protocol"
      via: "topic format"
      pattern: "collection/\\*|collection/recordId"
---

<objective>
Create topic parsing and subscription matching utilities following PocketBase protocol.

Purpose: Enable subscription topic parsing (e.g., "posts/*", "posts/abc123") and matching logic for event routing.
Output: src/realtime/topics.ts with parsing and matching functions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-realtime-sse/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create topic parsing utilities</name>
  <files>src/realtime/topics.ts, src/realtime/topics.test.ts</files>
  <action>
Create topic parsing and subscription matching utilities:

1. Create `src/realtime/topics.ts` with:
   - Import `Subscription` type from `./manager` (create it if manager.ts exists, otherwise define locally)
   - Note: If manager.ts doesn't exist yet (parallel wave), define Subscription interface locally:
     `interface Subscription { collection: string; recordId: string | "*"; }`

   - `parseTopic(topic: string): Subscription | null`
     - Parse topic format: "collection/*" or "collection/recordId"
     - Collection names: alphanumeric + underscore, start with letter
     - RecordId: "*" for wildcard, or alphanumeric nanoid
     - Return null for invalid formats
     - Regex: `/^([a-zA-Z][a-zA-Z0-9_]*)\/(\*|[a-zA-Z0-9]+)$/`

   - `matchesSubscription(sub: Subscription, collection: string, recordId: string): boolean`
     - Return false if collection doesn't match
     - If sub.recordId is "*", return true (wildcard matches all)
     - Otherwise, return sub.recordId === recordId

   - `formatTopic(collection: string, recordId: string | "*"): string`
     - Returns "{collection}/{recordId}" format

   - Export all functions

2. Create `src/realtime/topics.test.ts` with comprehensive tests:
   - parseTopic valid cases:
     - "posts/*" -> { collection: "posts", recordId: "*" }
     - "posts/abc123" -> { collection: "posts", recordId: "abc123" }
     - "my_collection/xyz" -> { collection: "my_collection", recordId: "xyz" }
   - parseTopic invalid cases (return null):
     - "" (empty)
     - "posts" (no slash)
     - "/posts" (starts with slash)
     - "123collection/*" (starts with number)
     - "posts/" (no recordId)
     - "posts/abc/123" (too many slashes)
     - "my-collection/*" (hyphen not allowed)
   - matchesSubscription:
     - Wildcard matches any record in collection
     - Specific recordId only matches that record
     - Different collection returns false
   - formatTopic:
     - Formats collection and recordId correctly
  </action>
  <verify>Run `bun test src/realtime/topics.test.ts` - all tests pass</verify>
  <done>Topic parsing handles "collection/*" and "collection/recordId" formats, matching works for wildcards</done>
</task>

</tasks>

<verification>
- `bun test src/realtime/topics.test.ts` passes all tests
- parseTopic returns null for malformed topics
- matchesSubscription correctly handles wildcard vs specific record matching
</verification>

<success_criteria>
1. Topic parsing correctly identifies collection and recordId
2. Invalid topics return null (fail-safe)
3. Wildcard subscriptions match all records in collection
4. Specific record subscriptions only match that record
5. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/12-realtime-sse/12-02-SUMMARY.md`
</output>

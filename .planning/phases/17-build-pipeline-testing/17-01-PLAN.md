---
phase: 17-build-pipeline-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/routes.test.ts
autonomous: true

must_haves:
  truths:
    - "bun run build:routes generates src/routes-generated.ts successfully"
    - "Generated manifest contains health and stats routes"
    - "Custom routes work in development mode (without compilation)"
    - "Health route returns { status: 'ok' } in dev mode"
    - "Stats route uses database context and returns collection statistics"
  artifacts:
    - path: "tests/routes.test.ts"
      provides: "Route manifest and dev mode integration tests"
      min_lines: 80
  key_links:
    - from: "tests/routes.test.ts"
      to: "src/routes-generated.ts"
      via: "dynamic import after build:routes"
      pattern: "import.*routes-generated"
    - from: "tests/routes.test.ts"
      to: "/api/health"
      via: "fetch request to dev server"
      pattern: "fetch.*api/health"
---

<objective>
Test route manifest generation and custom routes in development mode

Purpose: Verify that build:routes script generates valid manifest and custom routes work correctly when running in development mode (without binary compilation). This ensures the foundation is solid before testing the compiled binary.

Output: tests/routes.test.ts with manifest generation tests and development mode integration tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-build-pipeline-testing/17-RESEARCH.md
@scripts/build-routes.ts
@src/routes-generated.ts (generated after build:routes)
@routes/health.ts
@routes/stats.ts
@src/api/server.ts
@src/api/server.test.ts (for test patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create route manifest generation tests</name>
  <files>tests/routes.test.ts</files>
  <action>
Create tests/routes.test.ts with tests for route manifest generation:

1. Test that `bun run build:routes` executes successfully (exit code 0)
   - Use Bun.spawnSync() to run the script
   - Verify result.success is true

2. Test that src/routes-generated.ts exists after running build:routes
   - Use Bun.file() to check existence

3. Test that the generated manifest is valid TypeScript
   - Dynamic import the module
   - Verify it exports buildCustomRoutes (function)
   - Verify it exports routeManifest (object with routes array)

4. Test that routeManifest.routes contains the expected routes:
   - /api/health with GET method
   - /api/stats with GET method

Use describe/test from bun:test. Follow existing test patterns from src/api/server.test.ts.
  </action>
  <verify>bun test tests/routes.test.ts --filter "Route Manifest Generation" passes</verify>
  <done>All manifest generation tests pass, confirming build:routes produces valid output</done>
</task>

<task type="auto">
  <name>Task 2: Add development mode integration tests</name>
  <files>tests/routes.test.ts</files>
  <action>
Add a second describe block to tests/routes.test.ts for development mode tests:

1. In beforeAll:
   - Run build:routes first (required for routes-generated.ts)
   - Import initDatabase, closeDatabase from src/core/database
   - Import createServer from src/api/server
   - Import buildCustomRoutes, routeManifest from src/routes-generated
   - Import HookManager from src/core/hooks
   - Import RealtimeManager from src/realtime/manager
   - Initialize in-memory database
   - Create HookManager and RealtimeManager instances
   - Build custom routes with dependencies
   - Start server on port 8097 (unique port for this test file)

2. In afterAll:
   - Stop server
   - Close database

3. Test cases:
   a. "health route returns 200 with status ok"
      - GET http://localhost:8097/api/health
      - Verify status 200
      - Verify body contains { status: "ok" }

   b. "stats route returns 200 with collections array"
      - GET http://localhost:8097/api/stats
      - Verify status 200
      - Verify body contains collections (array) and count (number)

   c. "stats route uses database context" (verify ctx.db works)
      - The stats route queries _collections table
      - If no collections exist, response should have count: 0, collections: []

Use PORT 8097 to avoid conflicts with other test files (8091 used by server.test.ts).
  </action>
  <verify>bun test tests/routes.test.ts passes all tests including development mode</verify>
  <done>Development mode tests verify health returns { status: "ok" } and stats uses database context</done>
</task>

</tasks>

<verification>
Run full test suite:
```bash
bun test tests/routes.test.ts
```

Expected: All tests pass (manifest generation + development mode integration)
</verification>

<success_criteria>
- tests/routes.test.ts exists with at least 80 lines
- `bun test tests/routes.test.ts` passes all tests
- Tests verify build:routes generates valid manifest
- Tests verify health route returns { status: "ok" } in dev mode
- Tests verify stats route uses database context
</success_criteria>

<output>
After completion, create `.planning/phases/17-build-pipeline-testing/17-01-SUMMARY.md`
</output>

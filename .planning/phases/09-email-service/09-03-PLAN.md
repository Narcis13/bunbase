---
phase: 09-email-service
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - src/cli.ts
  - src/api/server.ts
  - src/email/send.test.ts
autonomous: true

must_haves:
  truths:
    - "Developer can configure SMTP via --smtp-host, --smtp-port, --smtp-user, --smtp-pass flags"
    - "Developer can configure SMTP via SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS env vars"
    - "CLI flags take precedence over environment variables"
    - "Server starts successfully even when SMTP is not configured"
    - "Email service is initialized when SMTP config is valid"
    - "Tests verify placeholder replacement and configuration loading"
  artifacts:
    - path: "src/cli.ts"
      provides: "SMTP CLI flag parsing"
      contains: "smtp-host"
    - path: "src/api/server.ts"
      provides: "Email service initialization"
      contains: "initEmailService"
    - path: "src/email/send.test.ts"
      provides: "Email service unit tests"
      min_lines: 50
  key_links:
    - from: "src/cli.ts"
      to: "src/api/server.ts"
      via: "smtpConfig parameter"
      pattern: "startServer.*smtpConfig"
    - from: "src/api/server.ts"
      to: "src/email/index.ts"
      via: "initEmailService import"
      pattern: "import.*initEmailService.*from.*email"
---

<objective>
Integrate email service with CLI and server, add comprehensive tests.

Purpose: Make the email service accessible to developers via standard CLI configuration patterns. Ensure the feature is tested and production-ready for Phase 10 (User Authentication) to use.

Output: Complete, tested email service integrated into BunBase startup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-email-service/09-RESEARCH.md

# Prior plan artifacts
@src/email/index.ts

# Files to modify
@src/cli.ts
@src/api/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SMTP CLI flags and update help message</name>
  <files>src/cli.ts</files>
  <action>
Update `src/cli.ts` to add SMTP configuration flags:

1. **Import loadSmtpConfig:**
   ```typescript
   import { loadSmtpConfig, SmtpConfig } from "./email";
   ```

2. **Add SMTP options to parseArgs:**
   ```typescript
   "smtp-host": { type: "string" },
   "smtp-port": { type: "string" },
   "smtp-user": { type: "string" },
   "smtp-pass": { type: "string" },
   "smtp-from": { type: "string" },
   ```

3. **Update showHelp() to include SMTP options:**
   Add to the Options section:
   ```
   SMTP Options:
     --smtp-host <host>   SMTP server hostname (or SMTP_HOST env var)
     --smtp-port <port>   SMTP server port (default: 587, or SMTP_PORT)
     --smtp-user <user>   SMTP username (or SMTP_USER env var)
     --smtp-pass <pass>   SMTP password (or SMTP_PASS env var)
     --smtp-from <addr>   Default from address (or SMTP_FROM, defaults to smtp-user)
   ```

4. **Load SMTP config after parsing:**
   ```typescript
   const smtpConfig = loadSmtpConfig({
     host: values["smtp-host"],
     port: values["smtp-port"],
     user: values["smtp-user"],
     pass: values["smtp-pass"],
     from: values["smtp-from"],
   });
   ```

5. **Pass smtpConfig to startServer:**
   Update the startServer call to pass smtpConfig (will be `SmtpConfig | null`).
  </action>
  <verify>
Run `bun src/cli.ts --help` and verify SMTP options appear in output.
Run `bun build src/cli.ts` - should compile without errors.
  </verify>
  <done>
CLI parses --smtp-host, --smtp-port, --smtp-user, --smtp-pass, --smtp-from flags. Help message updated with SMTP Options section. smtpConfig loaded and passed to startServer.
  </done>
</task>

<task type="auto">
  <name>Task 2: Initialize email service in server startup</name>
  <files>src/api/server.ts</files>
  <action>
Update `src/api/server.ts` to initialize email service:

1. **Add import:**
   ```typescript
   import { initEmailService, SmtpConfig, isEmailConfigured } from "../email";
   ```

2. **Update startServer signature:**
   ```typescript
   export async function startServer(
     port: number = 8090,
     dbPath: string = "bunbase.db",
     hooks?: HookManager,
     smtpConfig?: SmtpConfig | null
   )
   ```

3. **Initialize email service after database init:**
   ```typescript
   // Initialize email service if configured
   if (smtpConfig) {
     initEmailService(smtpConfig);
     console.log(`Email service configured (${smtpConfig.host}:${smtpConfig.port})`);
   }
   ```

4. **Do NOT block startup if email unconfigured:**
   - No error if smtpConfig is null/undefined
   - Server starts normally either way
   - Just skip the console.log if not configured

5. **Maintain backward compatibility:**
   - smtpConfig parameter is optional
   - Existing tests and usage without smtpConfig continue to work
  </action>
  <verify>
Run `bun src/cli.ts --port 8099` - should start without SMTP (no email message).
Run `bun src/cli.ts --port 8099 --smtp-host smtp.example.com --smtp-user test --smtp-pass test` - should show "Email service configured" message.
(Stop server after each test with Ctrl+C)
  </verify>
  <done>
startServer accepts optional smtpConfig parameter. Email service initialized when config provided. Startup console message shows SMTP host:port when configured. Server starts normally without SMTP config.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for email service</name>
  <files>src/email/send.test.ts</files>
  <action>
Create `src/email/send.test.ts` with comprehensive tests:

```typescript
import { test, expect, describe, beforeEach } from "bun:test";
import { loadSmtpConfig } from "./config";
import { replacePlaceholders } from "./templates";
import { isEmailConfigured } from "./transport";
```

**Test Groups:**

1. **loadSmtpConfig tests:**
   - Returns null when host missing
   - Returns null when user missing
   - Returns null when pass missing
   - Returns SmtpConfig when all required present
   - CLI values override env vars
   - Defaults port to 587 when not specified
   - Sets secure: true for port 465
   - Sets secure: false for port 587
   - Defaults from to user when not specified

2. **replacePlaceholders tests:**
   - Replaces single placeholder
   - Replaces multiple placeholders
   - Preserves unmatched placeholders ({{missing}} stays as-is)
   - Handles empty template (returns empty string)
   - Handles empty values object (returns template unchanged)
   - Handles template with no placeholders (returns unchanged)
   - Only matches word characters in placeholder names ({{foo-bar}} not matched)

3. **isEmailConfigured tests:**
   - Returns false before initialization
   - (Cannot easily test "returns true after init" without mocking SMTP server)

Use `describe()` blocks to group related tests. Use clear test names that describe the expected behavior.
  </action>
  <verify>
Run `bun test src/email/send.test.ts` - all tests should pass.
  </verify>
  <done>
Unit tests cover loadSmtpConfig (null cases, config cases, precedence, defaults), replacePlaceholders (replacement, preservation, edge cases), and isEmailConfigured (false before init). All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `bun test` - all existing tests plus new email tests pass
2. `bun src/cli.ts --help` shows SMTP options
3. Server starts without SMTP config (graceful degradation)
4. Server shows email configured message when SMTP provided
5. No breaking changes to existing functionality
</verification>

<success_criteria>
- CLI accepts --smtp-host, --smtp-port, --smtp-user, --smtp-pass, --smtp-from flags
- Help message documents SMTP options with env var alternatives
- CLI flags take precedence over env vars (tested)
- startServer initializes email service when config provided
- Server starts successfully when SMTP not configured
- Console message confirms email configuration on startup
- Unit tests cover config loading, placeholder replacement, and state checking
- All tests pass: `bun test`
- Phase 9 requirements met:
  - EMAIL-01: SMTP configuration via CLI/env vars (done)
  - EMAIL-02: Send email function with to, subject, body (done in Plan 02)
  - EMAIL-03: Template placeholders for tokens/links (done in Plans 01-02)
</success_criteria>

<output>
After completion, create `.planning/phases/09-email-service/09-03-SUMMARY.md`
</output>

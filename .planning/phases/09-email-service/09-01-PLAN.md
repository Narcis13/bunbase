---
phase: 09-email-service
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/email/config.ts
  - src/email/templates.ts
autonomous: true

must_haves:
  truths:
    - "SMTP configuration types are defined and importable"
    - "Template placeholder replacement handles {{key}} patterns"
    - "Missing placeholders are preserved (not replaced with undefined)"
  artifacts:
    - path: "src/email/config.ts"
      provides: "SmtpConfig interface and loadSmtpConfig function"
      exports: ["SmtpConfig", "loadSmtpConfig"]
    - path: "src/email/templates.ts"
      provides: "Template placeholder replacement utility"
      exports: ["replacePlaceholders"]
  key_links: []
---

<objective>
Create email service foundation: configuration types and template utilities.

Purpose: Establish the types and utilities that the email transport and send functions will depend on. This separates configuration loading from transport creation, enabling graceful degradation when SMTP is not configured.

Output: Two foundational files that the email service will build upon.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-email-service/09-RESEARCH.md

# Existing CLI pattern for configuration loading
@src/cli.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SMTP configuration types and loader</name>
  <files>src/email/config.ts</files>
  <action>
Create `src/email/config.ts` with:

1. **SmtpConfig interface:**
   ```typescript
   export interface SmtpConfig {
     host: string;
     port: number;
     user: string;
     pass: string;
     secure: boolean;  // true for port 465, false for 587
     from: string;     // Default sender address
   }
   ```

2. **SmtpCliValues interface** for partial CLI input:
   ```typescript
   export interface SmtpCliValues {
     host?: string;
     port?: string;
     user?: string;
     pass?: string;
     from?: string;
   }
   ```

3. **loadSmtpConfig function:**
   - Takes `SmtpCliValues` from CLI parsing
   - CLI flags take precedence over env vars (SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, SMTP_FROM)
   - Returns `SmtpConfig | null` (null means email disabled)
   - Auto-detect `secure: true` for port 465, `false` for other ports
   - Default `from` to user if not provided
   - Return null if host, user, or pass are missing (email is optional)

Follow the pattern from existing cli.ts for env var access via `Bun.env`.
  </action>
  <verify>
Run `bun build src/email/config.ts` - should compile without errors.
Manually verify exports are correct with: `bun -e "import { SmtpConfig, loadSmtpConfig } from './src/email/config.ts'; console.log(typeof loadSmtpConfig)"`
  </verify>
  <done>
SmtpConfig interface exported. loadSmtpConfig returns null when SMTP unconfigured, returns valid SmtpConfig when all required fields present. Secure mode auto-detected from port.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create template placeholder replacement utility</name>
  <files>src/email/templates.ts</files>
  <action>
Create `src/email/templates.ts` with:

1. **replacePlaceholders function:**
   ```typescript
   export function replacePlaceholders(
     template: string,
     values: Record<string, string>
   ): string
   ```

2. **Implementation:**
   - Use regex `/\{\{(\w+)\}\}/g` to match `{{key}}` patterns
   - Replace matched keys with values from the `values` object
   - **Important:** If a key is not found in values, preserve the original `{{key}}` (don't replace with undefined or empty string)
   - Handle empty template gracefully (return empty string)
   - Handle empty values object gracefully (return template unchanged)

3. **Type safety:**
   - Input template must be string
   - Values must be Record<string, string>
   - Return type is string

This is a pure function with no side effects, making it easy to test.
  </action>
  <verify>
Run `bun -e "import { replacePlaceholders } from './src/email/templates.ts'; console.log(replacePlaceholders('Hello {{name}}, your token is {{token}}', { name: 'User', token: 'abc123' }))"`
Expected output: "Hello User, your token is abc123"

Run `bun -e "import { replacePlaceholders } from './src/email/templates.ts'; console.log(replacePlaceholders('Missing: {{missing}}', {}))"`
Expected output: "Missing: {{missing}}" (preserved)
  </verify>
  <done>
replacePlaceholders function exported. Replaces {{key}} patterns with values. Missing keys preserved. Empty inputs handled gracefully.
  </done>
</task>

</tasks>

<verification>
1. Both files compile without TypeScript errors: `bun build src/email/config.ts src/email/templates.ts`
2. Exports are accessible from other modules
3. No runtime dependencies introduced yet (nodemailer comes in Plan 02)
</verification>

<success_criteria>
- SmtpConfig and loadSmtpConfig exported from src/email/config.ts
- loadSmtpConfig returns null when SMTP not configured (missing host/user/pass)
- loadSmtpConfig returns SmtpConfig when all required fields present
- replacePlaceholders replaces {{key}} patterns correctly
- replacePlaceholders preserves unmatched {{key}} patterns
- Both files have no external dependencies (pure TypeScript)
</success_criteria>

<output>
After completion, create `.planning/phases/09-email-service/09-01-SUMMARY.md`
</output>

---
phase: 07-admin-ui-schema-editor
plan: 04
type: execute
wave: 3
depends_on: ["07-03"]
files_modified:
  - src/admin/App.tsx
  - src/admin/components/layout/AppSidebar.tsx
  - src/admin/components/schema/CreateCollectionSheet.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can navigate to schema editor from collection view"
    - "Admin can create a new collection from the sidebar"
    - "Schema changes appear immediately in sidebar"
    - "Deleting collection returns to dashboard"
  artifacts:
    - path: "src/admin/App.tsx"
      provides: "Extended view state with schema view"
      contains: "type.*schema"
    - path: "src/admin/components/layout/AppSidebar.tsx"
      provides: "Schema edit button and create collection button"
      contains: "Edit Schema"
    - path: "src/admin/components/schema/CreateCollectionSheet.tsx"
      provides: "Form to create new collection"
      contains: "CreateCollectionSheet"
  key_links:
    - from: "src/admin/App.tsx"
      to: "src/admin/components/schema/SchemaView.tsx"
      via: "renders SchemaView for schema view type"
      pattern: "SchemaView"
    - from: "src/admin/components/layout/AppSidebar.tsx"
      to: "src/admin/lib/api.ts"
      via: "calls createCollection"
      pattern: "createCollection"
---

<objective>
Integrate the schema editor into the admin UI with navigation from collection view, create collection functionality in sidebar, and proper view state handling.

Purpose: Users need to navigate to the schema editor and create new collections. This plan wires up the schema editor components into the existing app routing and adds create collection capability.

Output: Complete integration of schema editor with navigation and collection creation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/admin/App.tsx
@src/admin/components/layout/AppSidebar.tsx
@src/admin/components/layout/Layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CreateCollectionSheet component</name>
  <files>src/admin/components/schema/CreateCollectionSheet.tsx</files>
  <action>
Create `src/admin/components/schema/CreateCollectionSheet.tsx`:

```typescript
/**
 * Create collection sheet - form to create a new collection.
 * Opens from sidebar "New Collection" button.
 */

import { useState } from "react";
import { useForm } from "react-hook-form";
import { toast } from "sonner";
import { createCollection, type FieldInput } from "@/lib/api";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
} from "@/components/ui/sheet";

interface CreateCollectionSheetProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onCreated: (collectionName: string) => void;
}

interface FormData {
  name: string;
}

/**
 * CreateCollectionSheet allows creating a new empty collection.
 * After creation, navigates to the schema editor to add fields.
 */
export function CreateCollectionSheet({
  open,
  onOpenChange,
  onCreated,
}: CreateCollectionSheetProps) {
  const [loading, setLoading] = useState(false);

  const {
    register,
    handleSubmit,
    reset,
    formState: { errors },
  } = useForm<FormData>({
    defaultValues: { name: "" },
  });

  const onSubmit = async (data: FormData) => {
    setLoading(true);
    try {
      // Create empty collection (no fields initially)
      await createCollection(data.name, []);
      toast.success(`Collection "${data.name}" created`);
      reset();
      onOpenChange(false);
      // Navigate to schema editor for the new collection
      onCreated(data.name);
    } catch (e) {
      toast.error((e as Error).message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <Sheet open={open} onOpenChange={onOpenChange}>
      <SheetContent>
        <SheetHeader>
          <SheetTitle>New Collection</SheetTitle>
          <SheetDescription>
            Create a new collection. You can add fields in the schema editor
            after creation.
          </SheetDescription>
        </SheetHeader>
        <form onSubmit={handleSubmit(onSubmit)} className="mt-6 space-y-6">
          <div className="space-y-2">
            <Label htmlFor="collection-name">Collection Name</Label>
            <Input
              id="collection-name"
              placeholder="e.g., posts, products, users"
              {...register("name", {
                required: "Collection name is required",
                pattern: {
                  value: /^[a-zA-Z][a-zA-Z0-9_]*$/,
                  message:
                    "Must start with letter, contain only letters, numbers, underscores",
                },
                validate: {
                  notSystem: (value) =>
                    !value.startsWith("_") ||
                    "Names starting with underscore are reserved for system collections",
                },
              })}
              disabled={loading}
            />
            {errors.name && (
              <p className="text-sm text-destructive">{errors.name.message}</p>
            )}
            <p className="text-xs text-muted-foreground">
              Use lowercase letters and underscores (e.g., blog_posts)
            </p>
          </div>

          <Button type="submit" className="w-full" disabled={loading}>
            {loading ? "Creating..." : "Create Collection"}
          </Button>
        </form>
      </SheetContent>
    </Sheet>
  );
}
```
  </action>
  <verify>TypeScript compiles: `bun build src/admin/components/schema/CreateCollectionSheet.tsx --no-bundle` succeeds.</verify>
  <done>CreateCollectionSheet component ready for integration with sidebar.</done>
</task>

<task type="auto">
  <name>Task 2: Update AppSidebar with schema navigation and create collection</name>
  <files>src/admin/components/layout/AppSidebar.tsx</files>
  <action>
Update `src/admin/components/layout/AppSidebar.tsx` to add:
1. "Edit Schema" button next to each collection
2. "New Collection" button at the bottom of collections list

Read the current file first, then modify it to add:

1. Import CreateCollectionSheet and Settings icon:
```typescript
import { Database, Settings, Plus } from "lucide-react";
import { CreateCollectionSheet } from "@/components/schema/CreateCollectionSheet";
```

2. Add state for create collection sheet:
```typescript
const [createOpen, setCreateOpen] = useState(false);
```

3. Update the AppSidebarProps interface to include schema navigation:
```typescript
interface AppSidebarProps {
  currentCollection?: string;
  onNavigate: (view: { type: string; collection?: string }) => void;
  onSchemaEdit?: (collection: string) => void;  // ADD THIS
}
```

4. Add the onSchemaEdit prop to the component:
```typescript
export function AppSidebar({ currentCollection, onNavigate, onSchemaEdit }: AppSidebarProps)
```

5. In each collection button area, add an "Edit Schema" button that appears on hover:
```typescript
<div className="flex items-center justify-between group">
  <SidebarMenuButton
    isActive={currentCollection === collection.name}
    onClick={() => onNavigate({ type: "collection", collection: collection.name })}
    className="flex-1"
  >
    <Database className="h-4 w-4" />
    <span className="truncate">{collection.name}</span>
    <span className="ml-auto text-xs text-muted-foreground">
      {collection.recordCount}
    </span>
  </SidebarMenuButton>
  {onSchemaEdit && (
    <Button
      variant="ghost"
      size="sm"
      className="h-7 w-7 p-0 opacity-0 group-hover:opacity-100 transition-opacity"
      onClick={(e) => {
        e.stopPropagation();
        onSchemaEdit(collection.name);
      }}
      title="Edit Schema"
    >
      <Settings className="h-3.5 w-3.5" />
    </Button>
  )}
</div>
```

6. Add "New Collection" button at the bottom of the collections section:
```typescript
<SidebarGroupContent>
  <SidebarMenu>
    {/* ... existing collection items ... */}
  </SidebarMenu>
  <Button
    variant="outline"
    size="sm"
    className="w-full mt-2"
    onClick={() => setCreateOpen(true)}
  >
    <Plus className="mr-2 h-4 w-4" />
    New Collection
  </Button>
</SidebarGroupContent>
```

7. Add CreateCollectionSheet at the end of the component:
```typescript
<CreateCollectionSheet
  open={createOpen}
  onOpenChange={setCreateOpen}
  onCreated={(name) => {
    refetch();  // Refresh collections list
    if (onSchemaEdit) {
      onSchemaEdit(name);  // Navigate to schema editor
    }
  }}
/>
```

Note: The refetch function needs to be passed to or implemented within AppSidebar. Check if there's already a refetch mechanism or add one via callback prop.
  </action>
  <verify>TypeScript compiles: `bun build src/admin/components/layout/AppSidebar.tsx --no-bundle` succeeds.</verify>
  <done>AppSidebar has schema edit buttons, new collection button, and create collection sheet integration.</done>
</task>

<task type="auto">
  <name>Task 3: Extend App.tsx view state for schema editor</name>
  <files>src/admin/App.tsx</files>
  <action>
Update `src/admin/App.tsx` to:
1. Add schema view type
2. Import and render SchemaView
3. Wire up navigation callbacks

Read the current file first, then modify:

1. Import SchemaView:
```typescript
import { SchemaView } from "@/components/schema/SchemaView";
```

2. Extend the View type:
```typescript
type View =
  | { type: "dashboard" }
  | { type: "collection"; collection: string }
  | { type: "schema"; collection: string };  // ADD THIS
```

3. Update the handleNavigate function to handle schema view:
```typescript
const handleNavigate = (newView: { type: string; collection?: string }) => {
  if (newView.type === "dashboard") {
    setView({ type: "dashboard" });
  } else if (newView.type === "collection" && newView.collection) {
    setView({ type: "collection", collection: newView.collection });
  } else if (newView.type === "schema" && newView.collection) {
    setView({ type: "schema", collection: newView.collection });
  }
};
```

4. Add schema edit handler:
```typescript
const handleSchemaEdit = (collection: string) => {
  setView({ type: "schema", collection });
};
```

5. Update the Layout component to pass onSchemaEdit:
```typescript
<Layout
  currentCollection={view.type === "collection" ? view.collection : view.type === "schema" ? view.collection : undefined}
  onNavigate={handleNavigate}
  onSchemaEdit={handleSchemaEdit}
>
```

6. Add SchemaView rendering in the return:
```typescript
{view.type === "schema" && (
  <SchemaView
    collection={view.collection}
    onBack={() => setView({ type: "collection", collection: view.collection })}
    onCollectionDeleted={() => setView({ type: "dashboard" })}
  />
)}
```

7. Update Layout.tsx to pass through onSchemaEdit to AppSidebar:
   - Add onSchemaEdit to LayoutProps interface
   - Pass it to AppSidebar component
  </action>
  <verify>Start dev server: `bun --hot src/api/server.ts &`
Navigate to http://localhost:8090/_/ and verify:
1. Collections show Settings icon on hover
2. "New Collection" button appears at bottom of collections
3. Clicking Settings icon shows schema editor
4. Creating a new collection navigates to schema editor</verify>
  <done>App.tsx has schema view routing and navigation wired up.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete schema editor integration with navigation, create collection, and field CRUD</what-built>
  <how-to-verify>
1. Start the server: `bun --hot src/api/server.ts`
2. Open http://localhost:8090/_/ and log in with admin credentials
3. Test create collection:
   - Click "New Collection" button in sidebar
   - Enter collection name (e.g., "products")
   - Verify it creates and navigates to schema editor
4. Test add field:
   - Click "Add Field" button
   - Fill in: name="title", type="text", required=on
   - Click "Create Field"
   - Verify field appears in table
5. Test edit field:
   - Click the three-dot menu on the field row
   - Click "Edit"
   - Change required to off
   - Click "Update Field"
   - Verify change appears
6. Test delete field:
   - Click the three-dot menu on a field
   - Click "Delete"
   - Confirm deletion
   - Verify field is removed
7. Test delete collection:
   - Click "Delete Collection" button
   - Confirm deletion
   - Verify it returns to dashboard and collection is gone from sidebar
8. Test navigation:
   - Hover over a collection in sidebar - Settings icon should appear
   - Click Settings icon - should show schema editor
   - Click "Back" button - should return to records view
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Create collection form validates name (starts with letter, alphanumeric + underscore)
2. Create collection creates empty collection and navigates to schema editor
3. Schema editor shows fields table with add/edit/delete
4. Adding/editing fields uses Select for type dropdown
5. Relation fields show target collection selector
6. Delete confirmations warn about data loss
7. Navigation works: sidebar -> schema -> back to records
8. Schema changes reflect immediately in the UI
</verification>

<success_criteria>
1. Admin can create a new collection via "New Collection" button
2. Admin can navigate to schema editor via Settings icon on collection
3. Admin can add, edit, and delete fields
4. Admin can delete entire collection
5. Schema changes take effect immediately (new fields usable in records view)
6. All navigation flows work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-ui-schema-editor/07-04-SUMMARY.md`
</output>

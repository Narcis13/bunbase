---
phase: 15-route-loading
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/routes/discovery.ts
  - src/routes/discovery.test.ts
autonomous: true

must_haves:
  truths:
    - "filePathToRoutePath converts routes/health.ts to /api/health"
    - "filePathToRoutePath converts routes/users/[id].ts to /api/users/:id"
    - "filePathToRoutePath converts routes/users/index.ts to /api/users"
    - "parseRouteExports extracts GET, POST exports from TypeScript files"
    - "parseRouteExports warns on lowercase method exports (get, post)"
  artifacts:
    - path: "src/routes/discovery.ts"
      provides: "Route discovery and path conversion utilities"
      exports: ["filePathToRoutePath", "generateImportName", "parseRouteExports", "VALID_METHODS"]
    - path: "src/routes/discovery.test.ts"
      provides: "Test coverage for route discovery"
      min_lines: 80
  key_links:
    - from: "src/routes/discovery.ts"
      to: "typescript"
      via: "TypeScript Compiler API for export parsing"
      pattern: "ts\\.createSourceFile"
---

<objective>
Create route discovery utilities for converting file paths to API routes and validating HTTP method exports.

Purpose: Establish the core logic that scripts/build-routes.ts will use to scan the routes/ directory and generate the manifest. This is pure utility code with well-defined inputs/outputs - ideal for TDD.

Output: `src/routes/discovery.ts` with tested path conversion and export parsing functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-route-loading/15-RESEARCH.md
@src/api/context.ts
@src/api/errors.ts
</context>

<feature>
  <name>Route Discovery Utilities</name>
  <files>src/routes/discovery.ts, src/routes/discovery.test.ts</files>
  <behavior>
    filePathToRoutePath(filePath: string, routesDir: string): string
    - Input: "routes/health.ts" -> Output: "/api/health"
    - Input: "routes/stats.ts" -> Output: "/api/stats"
    - Input: "routes/users/index.ts" -> Output: "/api/users"
    - Input: "routes/users/[id].ts" -> Output: "/api/users/:id"
    - Input: "routes/users/[id]/posts.ts" -> Output: "/api/users/:id/posts"
    - Input: "routes/users/[userId]/posts/[postId].ts" -> Output: "/api/users/:userId/posts/:postId"
    - Windows paths: "routes\\health.ts" -> "/api/health"

    generateImportName(filePath: string, routesDir: string): string
    - Input: "routes/health.ts" -> Output: "route_health"
    - Input: "routes/users/[id].ts" -> Output: "route_users_$id"
    - Input: "routes/users/[id]/posts.ts" -> Output: "route_users_$id_posts"
    - Must produce valid JavaScript identifier (no dashes, dots, etc.)

    parseRouteExports(sourceCode: string, filePath: string): { methods: string[], warnings: { message: string }[] }
    - Detects: export const GET, export const POST, export function GET, export function POST
    - Valid methods: GET, POST, PUT, PATCH, DELETE, HEAD, OPTIONS
    - Warns on lowercase: export const get -> warning "Use uppercase GET instead of get"
    - Ignores non-method exports: export const helper = ... (no warning, no inclusion)
    - Handles comments: // export const GET inside comment should not match
    - Handles strings: "export const GET" in string should not match
  </behavior>
  <implementation>
    Use TypeScript Compiler API (ts.createSourceFile, ts.isVariableStatement, ts.isFunctionDeclaration) to parse exports.
    This is more robust than regex - handles comments, strings, and all valid TypeScript syntax.

    Export VALID_METHODS constant for reuse in build script.

    Path conversion uses string manipulation with:
    - Replace backslashes with forward slashes (Windows support)
    - Remove .ts/.tsx extension
    - Replace /index with empty string
    - Replace [param] with :param
    - Prepend /api
  </implementation>
</feature>

<verification>
```bash
bun test src/routes/discovery.test.ts
```

All tests pass including:
- Path conversion edge cases (index files, nested params, Windows paths)
- Export detection (const vs function, uppercase vs lowercase)
- Import name generation (valid identifiers, no collisions)
</verification>

<success_criteria>
- filePathToRoutePath correctly converts all documented path patterns
- generateImportName produces unique, valid JavaScript identifiers
- parseRouteExports accurately detects HTTP method exports using TypeScript AST
- parseRouteExports produces warnings for lowercase method names
- All tests pass with `bun test src/routes/discovery.test.ts`
</success_criteria>

<output>
After completion, create `.planning/phases/15-route-loading/15-01-SUMMARY.md`
</output>

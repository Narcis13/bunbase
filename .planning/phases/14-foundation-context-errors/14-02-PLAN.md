---
phase: 14-foundation-context-errors
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/context.ts
  - src/api/context.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "RouteContext interface defines db, records, auth, realtime, files, hooks properties"
    - "ctx.db returns the SQLite Database instance"
    - "ctx.records.get/list/create/update/delete work with hooks"
    - "ctx.auth.buildContext returns {isAdmin, user} from request"
    - "ctx.auth.requireAdmin throws UnauthorizedError if not admin"
    - "ctx.files.save/getPath/exists/delete wrap storage functions"
    - "ctx.realtime is the RealtimeManager instance"
    - "ctx.hooks is the HookManager instance"
    - "createRouteContext() creates context from request and dependencies"
  artifacts:
    - src/api/context.ts
    - src/api/context.test.ts
  key_links:
    - "RecordsAPI wraps createRecordWithHooks/updateRecordWithHooks/deleteRecordWithHooks"
    - "AuthAPI.requireAdmin throws UnauthorizedError (not returns Response)"
    - "createRouteContext receives ContextDependencies with hooks and realtime"
---

<objective>
Create the RouteContext interface and factory function for BunBase custom routes.

Purpose: Provide custom route handlers with type-safe access to all BunBase capabilities (database, records, auth, realtime, files, hooks) through a single context object.

Output: `src/api/context.ts` with RouteContext interface, supporting API interfaces (RecordsAPI, AuthAPI, FilesAPI), ContextDependencies interface, and createRouteContext factory function.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-foundation-context-errors/14-RESEARCH.md

Source files to understand existing APIs:
@src/core/database.ts (getDatabase function)
@src/core/records.ts (getRecord, listRecordsWithQuery, createRecordWithHooks, etc.)
@src/core/hooks.ts (HookManager class)
@src/auth/middleware.ts (extractBearerToken, optionalUser, requireAdmin, AuthenticatedUser)
@src/auth/jwt.ts (verifyAdminToken)
@src/realtime/manager.ts (RealtimeManager class)
@src/storage/files.ts (saveFile, getFilePath, fileExists, deleteFile)
@src/types/query.ts (QueryOptions, PaginatedResponse)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RouteContext interface and supporting types</name>
  <files>src/api/context.ts</files>
  <action>
Create `src/api/context.ts` with:

1. **Import dependencies**:
```typescript
import type { Database } from 'bun:sqlite';
import { getDatabase } from '../core/database';
import { getRecord, listRecordsWithQuery, createRecordWithHooks, updateRecordWithHooks, deleteRecordWithHooks } from '../core/records';
import { HookManager } from '../core/hooks';
import { RealtimeManager } from '../realtime/manager';
import { saveFile, getFilePath, fileExists, deleteFile } from '../storage/files';
import { optionalUser, requireAdmin as authRequireAdmin, extractBearerToken, type AuthenticatedUser } from '../auth/middleware';
import { verifyAdminToken } from '../auth/jwt';
import type { QueryOptions, PaginatedResponse } from '../types/query';
import { UnauthorizedError } from './errors';
```

2. **ContextDependencies interface**:
```typescript
export interface ContextDependencies {
  hooks: HookManager;
  realtime: RealtimeManager;
}
```

3. **RecordsAPI interface**:
```typescript
export interface RecordsAPI {
  get(collection: string, id: string): Record<string, unknown> | null;
  list(collection: string, options?: QueryOptions): PaginatedResponse<Record<string, unknown>>;
  create(collection: string, data: Record<string, unknown>): Promise<Record<string, unknown>>;
  update(collection: string, id: string, data: Record<string, unknown>): Promise<Record<string, unknown>>;
  delete(collection: string, id: string): Promise<void>;
}
```

4. **AuthAPI interface**:
```typescript
export interface AuthAPI {
  buildContext(req: Request): Promise<{ isAdmin: boolean; user: AuthenticatedUser | null }>;
  optionalUser(req: Request): Promise<AuthenticatedUser | null>;
  requireAdmin(req: Request): Promise<void>;
}
```

5. **FilesAPI interface**:
```typescript
export interface FilesAPI {
  save(collection: string, recordId: string, file: File): Promise<string>;
  getPath(collection: string, recordId: string, filename: string): string;
  exists(collection: string, recordId: string, filename: string): Promise<boolean>;
  delete(collection: string, recordId: string, filename: string): Promise<void>;
}
```

6. **RouteContext interface**:
```typescript
export interface RouteContext {
  request: Request;
  params: Record<string, string>;
  db: Database;
  records: RecordsAPI;
  auth: AuthAPI;
  realtime: RealtimeManager;
  files: FilesAPI;
  hooks: HookManager;
}
```

Add JSDoc comments to all interfaces.
  </action>
  <verify>bun run src/api/context.ts (should compile without errors)</verify>
  <done>All interfaces defined with proper types</done>
</task>

<task type="auto">
  <name>Task 2: Implement API factory functions and createRouteContext</name>
  <files>src/api/context.ts</files>
  <action>
Add implementation functions to `src/api/context.ts`:

1. **createRecordsAPI(hooks: HookManager): RecordsAPI**:
```typescript
function createRecordsAPI(hooks: HookManager): RecordsAPI {
  return {
    get: (collection, id) => getRecord(collection, id),
    list: (collection, options = {}) => listRecordsWithQuery(collection, options),
    create: (collection, data) => createRecordWithHooks(collection, data, hooks),
    update: (collection, id, data) => updateRecordWithHooks(collection, id, data, hooks),
    delete: (collection, id) => deleteRecordWithHooks(collection, id, hooks),
  };
}
```

2. **createAuthAPI(): AuthAPI**:
```typescript
function createAuthAPI(): AuthAPI {
  return {
    buildContext: async (req) => {
      const token = extractBearerToken(req);
      if (!token) {
        return { isAdmin: false, user: null };
      }
      const adminPayload = await verifyAdminToken(token);
      if (adminPayload) {
        return { isAdmin: true, user: null };
      }
      const user = await optionalUser(req);
      return { isAdmin: false, user };
    },
    optionalUser: (req) => optionalUser(req),
    requireAdmin: async (req) => {
      const result = await authRequireAdmin(req);
      if (result instanceof Response) {
        throw new UnauthorizedError('Admin authentication required');
      }
    },
  };
}
```

3. **createFilesAPI(): FilesAPI**:
```typescript
function createFilesAPI(): FilesAPI {
  return {
    save: saveFile,
    getPath: getFilePath,
    exists: fileExists,
    delete: deleteFile,
  };
}
```

4. **createRouteContext(req, params, deps): RouteContext** (exported):
```typescript
export function createRouteContext(
  req: Request,
  params: Record<string, string>,
  deps: ContextDependencies
): RouteContext {
  return {
    request: req,
    params,
    db: getDatabase(),
    records: createRecordsAPI(deps.hooks),
    auth: createAuthAPI(),
    realtime: deps.realtime,
    files: createFilesAPI(),
    hooks: deps.hooks,
  };
}
```

Export: RouteContext, RecordsAPI, AuthAPI, FilesAPI, ContextDependencies, createRouteContext
  </action>
  <verify>bun run src/api/context.ts (should compile without errors)</verify>
  <done>createRouteContext factory function implemented</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for RouteContext factory</name>
  <files>src/api/context.test.ts</files>
  <action>
Create `src/api/context.test.ts` with tests:

1. **Setup**: Initialize test database, create HookManager and RealtimeManager instances, create a test collection

2. **createRouteContext tests**:
- Returns object with all required properties (request, params, db, records, auth, realtime, files, hooks)
- db is the Database instance from getDatabase()
- hooks is the HookManager passed in deps
- realtime is the RealtimeManager passed in deps
- params contains route parameters

3. **RecordsAPI tests**:
- records.get() returns record or null
- records.list() returns paginated response
- records.create() creates record and triggers hooks
- records.update() updates record and triggers hooks
- records.delete() deletes record and triggers hooks

4. **AuthAPI tests**:
- auth.buildContext() returns {isAdmin: false, user: null} for no token
- auth.optionalUser() returns null for no token
- auth.requireAdmin() throws UnauthorizedError for no token

5. **FilesAPI tests**:
- files.getPath() returns correct path format
- files.exists() returns boolean
- (save/delete can be lighter tests since they wrap existing tested functions)

Use bun:test, mock Request objects with appropriate headers.
  </action>
  <verify>bun test src/api/context.test.ts</verify>
  <done>All tests pass</done>
</task>

</tasks>

<verification>
Run the full test suite to ensure no regressions:
```bash
bun test src/api/context.test.ts
```

Verify context provides access to all managers:
```bash
# Test should verify ctx.db, ctx.hooks, ctx.realtime, ctx.files, ctx.auth, ctx.records are all accessible
```
</verification>

<success_criteria>
- [ ] `src/api/context.ts` exists with RouteContext interface
- [ ] ContextDependencies interface accepts hooks and realtime
- [ ] RecordsAPI wraps hook-aware record operations
- [ ] AuthAPI.requireAdmin throws UnauthorizedError (not returns Response)
- [ ] FilesAPI wraps storage functions
- [ ] createRouteContext factory function creates complete context
- [ ] Tests pass for context creation and all API methods
</success_criteria>

<output>
After completion, create `.planning/phases/14-foundation-context-errors/14-02-SUMMARY.md`
</output>

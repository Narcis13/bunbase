# Features Research: BunBase v0.3 Custom API Endpoints

**Domain:** Custom API routes for Backend-as-a-Service (BaaS)
**Researched:** 2026-01-30
**Confidence:** HIGH (verified with PocketBase docs, Next.js conventions, industry standards)

## Executive Summary

Custom API endpoints are a critical extensibility feature for any BaaS platform. Developers expect to define routes using familiar conventions (file-based routing with exported handlers), full access to platform context (database, auth, records), and standardized error responses. PocketBase establishes the pattern with `routerAdd()` and typed error factories. The v0.3 scope (GET/POST only, directory convention, export handlers) aligns well with industry standards while maintaining simplicity.

---

## Custom Routes Features

### Table Stakes

Features users expect. Missing = product feels incomplete.

| Feature | Why Expected | Complexity | Dependencies | Notes |
|---------|--------------|------------|--------------|-------|
| **File-based route definition** | Next.js/SvelteKit trained developers on this pattern | Low | Build system | `routes/users/[id].ts` maps to `/api/custom/users/:id` |
| **Export named handlers** | `export const GET`, `export const POST` is the modern standard | Low | None | Case-sensitive, uppercase method names |
| **Full request access** | Headers, body, query params, path params | Low | None | Standard Web API Request object |
| **BunBase context injection** | Why use BunBase if you can't access its features? | Medium | Core modules | db, records, auth, files, realtime |
| **Current user access** | Custom routes need auth context | Low | Auth middleware | `ctx.user` or `ctx.auth` pattern |
| **Admin auth support** | Admin-only endpoints are common | Low | JWT middleware | Check admin token in route |
| **Standardized error responses** | Consistent API experience | Low | Error module | Match existing BunBase format |
| **Path parameters** | Dynamic routes like `/users/:id` | Low | Router | Extract from folder name `[id]` |
| **JSON response helpers** | Ergonomic response creation | Low | None | `Response.json()` already exists |

### Differentiators

Features that set product apart. Not expected, but valued.

| Feature | Value Proposition | Complexity | Dependencies | Notes |
|---------|-------------------|------------|--------------|-------|
| **Type-safe context** | Full TypeScript types for BunBase context | Low | Type definitions | DX improvement, catches errors early |
| **Records API in context** | Direct `ctx.records.create()` instead of imports | Medium | Records module | Cleaner custom route code |
| **Auto-validation with Zod** | Optional schema validation for request bodies | Medium | Zod integration | Could be phase 2 |
| **Route-level middleware** | Per-route auth requirements via exports | Medium | Middleware system | `export const middleware = [requireAuth]` |
| **Realtime broadcast access** | Push events from custom routes | Low | Realtime manager | `ctx.realtime.broadcast()` |
| **Files API in context** | Upload/download files from custom routes | Low | Storage module | `ctx.files.save()`, `ctx.files.get()` |

### Anti-Features

Features to deliberately NOT build in v0.3. Common overengineering mistakes.

| Anti-Feature | Why Avoid | What to Do Instead |
|--------------|-----------|-------------------|
| **PUT/PATCH/DELETE methods** | Scope creep; GET/POST handle 95% of cases | Add in future if requested; POST can handle updates |
| **Middleware chains** | Complex, debugging nightmare | Single optional auth check per route |
| **Route-level caching** | Premature optimization | Users can implement if needed |
| **GraphQL endpoints** | Different paradigm, huge complexity | Stick to REST; users wanting GraphQL can build it |
| **WebSocket routes** | Already have realtime via SSE | SSE covers most realtime needs |
| **Automatic CORS handling** | Different needs per deployment | Let users configure in their routes |
| **Rate limiting per route** | Infrastructure concern | Deploy behind a proxy or add globally later |
| **Hot reloading routes** | Binary embedding makes this impossible | Restart server; acceptable for BaaS |
| **Dynamic route registration** | Routes embedded at build time by design | Trade runtime flexibility for binary simplicity |

---

## Error Response System

### PocketBase Error Format (Reference Implementation)

Based on [PocketBase documentation](https://pocketbase.io/docs/go-routing/), the standard error response structure is:

```json
{
  "code": 400,
  "message": "Something went wrong while processing your request.",
  "data": {
    "title": {
      "code": "validation_length_invalid",
      "message": "The length must be exactly 255."
    }
  }
}
```

Key characteristics:
- `code` mirrors HTTP status code for programmatic handling
- `message` provides human-readable context
- `data` holds field-level validation errors (empty object if none)
- All API failures return status >= 400

### BunBase Current Error Format

From `src/api/server.ts`, BunBase currently uses a simpler format:

```json
{
  "error": "Error message here"
}
```

This is functional but inconsistent with PocketBase and lacks field-level validation support.

### Recommended Unified Error Format

Adopt PocketBase format for consistency:

```json
{
  "code": 400,
  "message": "Human-readable error message",
  "data": {}
}
```

**Migration strategy:**
1. Keep existing `{ error: string }` format working (backward compat)
2. Add new error factories that produce PocketBase format
3. Custom routes use new format exclusively
4. Gradually migrate built-in routes in future versions

### Error Categories and Status Codes

| Category | Status Code | Error Code | When to Use |
|----------|-------------|------------|-------------|
| **Bad Request** | 400 | `bad_request` | Invalid input, missing fields, malformed JSON |
| **Unauthorized** | 401 | `unauthorized` | Missing or invalid auth token |
| **Forbidden** | 403 | `forbidden` | Valid auth but insufficient permissions |
| **Not Found** | 404 | `not_found` | Resource doesn't exist |
| **Conflict** | 409 | `conflict` | Resource already exists (duplicate key) |
| **Validation Failed** | 400 | `validation_failed` | Schema/field validation errors |
| **Internal Error** | 500 | `internal_error` | Unexpected server errors (hide details from client) |
| **Too Many Requests** | 429 | `too_many_requests` | Rate limiting (future) |

### Error Factory Functions

Following PocketBase's pattern, provide convenience factories:

```typescript
// For custom route handlers - throw pattern
throw new BadRequestError("Missing required field", {
  email: { code: "required", message: "Email is required" }
});
throw new UnauthorizedError("Invalid token");
throw new ForbiddenError("Admin access required");
throw new NotFoundError("User not found");

// Or via context - method pattern
return ctx.error.badRequest("Missing required field");
return ctx.error.unauthorized("Invalid token");
return ctx.error.forbidden("Admin access required");
return ctx.error.notFound("User not found");
```

### Global Error Handler

PocketBase implements a global error handler that:
1. Converts all thrown errors to `ApiError` responses
2. Hides sensitive details from clients (stack traces, internal paths)
3. Shows full errors only in development mode (`--dev` flag)
4. Logs original errors to admin dashboard

**Recommended implementation:**

```typescript
// In route handler wrapper
try {
  return await handler(req, ctx);
} catch (error) {
  if (error instanceof ApiError) {
    return Response.json({
      code: error.code,
      message: error.message,
      data: error.data,
    }, { status: error.code });
  }

  // Log unexpected errors
  console.error("Unhandled error:", error);

  // Return generic error to client
  return Response.json({
    code: 500,
    message: isDev ? String(error) : "Internal server error",
    data: {},
  }, { status: 500 });
}
```

---

## Handler Signature Design

### Recommended Pattern

```typescript
// routes/users/[id].ts
import type { RouteContext } from "bunbase";

export const GET = async (ctx: RouteContext) => {
  const { id } = ctx.params;
  const user = ctx.records.get("users", id);

  if (!user) {
    throw new NotFoundError("User not found");
  }

  return Response.json(user);
};

export const POST = async (ctx: RouteContext) => {
  const body = await ctx.request.json();

  // Access authenticated user if present
  if (!ctx.user) {
    throw new UnauthorizedError("Login required");
  }

  const record = await ctx.records.create("posts", {
    ...body,
    authorId: ctx.user.id,
  });

  return Response.json(record, { status: 201 });
};
```

### RouteContext Interface

```typescript
interface RouteContext {
  // Request
  request: Request;
  params: Record<string, string>;

  // Auth (populated from Authorization header)
  user: AuthenticatedUser | null;
  isAdmin: boolean;

  // BunBase APIs
  db: Database;
  records: RecordsAPI;
  files: FilesAPI;
  realtime: RealtimeManager;

  // Error helpers (throw pattern)
  // Note: These could also be standalone imports
}

interface RecordsAPI {
  get: (collection: string, id: string) => Record<string, unknown> | null;
  list: (collection: string, options?: QueryOptions) => PaginatedResult;
  create: (collection: string, data: object) => Promise<Record<string, unknown>>;
  update: (collection: string, id: string, data: object) => Promise<Record<string, unknown>>;
  delete: (collection: string, id: string) => Promise<void>;
}

interface FilesAPI {
  save: (collection: string, recordId: string, file: File) => Promise<string>;
  get: (collection: string, recordId: string, filename: string) => string; // returns path
  delete: (collection: string, recordId: string, filename: string) => Promise<void>;
}
```

---

## Feature Dependencies

```
File-based routing
       |
       v
Export handlers (GET/POST) ----> Path parameters ([id])
       |
       v
RouteContext injection
       |
       +----> request, params (Low: just pass through)
       |
       +----> user, isAdmin (Low: reuse existing auth middleware)
       |
       +----> db (Low: getDatabase() export exists)
       |
       +----> records API (Medium: wrap existing functions)
       |
       +----> files API (Low: wrap existing functions)
       |
       +----> realtime (Low: pass RealtimeManager reference)
       |
       v
Binary embedding at build ----> Route discovery at compile time
```

### Existing BunBase Features Used

| v0.3 Feature | Depends On | Notes |
|--------------|------------|-------|
| Auth context | `optionalUser()`, `verifyAdminToken()` | Already in middleware.ts |
| Database access | `getDatabase()` | Already exported |
| Records operations | `getRecord()`, `createRecordWithHooks()`, etc. | Already in records.ts |
| Files operations | `saveFile()`, `getFilePath()`, `fileExists()` | Already in storage/ |
| Realtime broadcast | `RealtimeManager.broadcast()` | Already implemented |
| Error responses | `errorResponse()` | Needs upgrade to PocketBase format |

---

## MVP Recommendation

For v0.3 MVP, prioritize:

1. **File-based routing** with `routes/` directory convention
2. **Export GET/POST handlers** with uppercase names
3. **RouteContext with full access** (request, params, user, db, records, files, realtime)
4. **Typed error factories** (BadRequestError, UnauthorizedError, etc.)
5. **PocketBase-style error format** for consistency
6. **Build-time route discovery** for binary embedding

Defer to post-MVP:
- Route-level middleware exports (complexity vs. value)
- Request body validation integration (can use Zod manually for now)
- Additional HTTP methods (PUT/PATCH/DELETE)
- Error format migration for built-in routes

---

## Sources

**HIGH Confidence (Official Documentation):**
- [PocketBase JS Routing](https://pocketbase.io/docs/js-routing/) - Handler patterns, error factories, middleware
- [PocketBase Go Routing](https://pocketbase.io/docs/go-routing/) - ApiError structure, validation errors
- [Next.js Route Handlers](https://nextjs.org/docs/app/api-reference/file-conventions/route) - Export GET/POST convention
- [PocketBase API Records](https://pocketbase.io/docs/api-records/) - HTTP status code usage

**MEDIUM Confidence (Verified Community Sources):**
- [hono-file-router](https://github.com/thisjt/hono-file-router) - Bun-compatible file-based routing patterns
- [REST API Error Handling Best Practices 2025](https://blog.apilayer.com/best-practices-for-rest-api-error-handling-in-2025/) - Status codes, JSON structure
- [Zuplo API Error Handling](https://zuplo.com/blog/2025/02/11/best-practices-for-api-error-handling) - RFC 9457 Problem Details
- [Better-Auth API Patterns](https://deepwiki.com/better-auth/better-auth/2.3-api-routes-and-endpoints) - Context injection patterns

**LOW Confidence (General Context):**
- [Supabase vs Firebase comparison](https://anotherwrapper.com/blog/supabase-vs-firebase) - BaaS feature expectations
- WebSearch results for BaaS custom endpoints (2025-2026)

---

*Last updated: 2026-01-30*
